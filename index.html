<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>GuiarCapital</title>
    <link rel="manifest" href="/manifest.json">
    <meta name="theme-color" content="#3b82f6">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #1e293b 0%, #334155 100%);
            color: #e2e8f0;
            min-height: 100vh;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
        }

        .header {
            text-align: center;
            margin-bottom: 30px;
            padding: 20px;
            background: rgba(59, 130, 246, 0.1);
            border-radius: 15px;
            backdrop-filter: blur(10px);
            border: 1px solid rgba(59, 130, 246, 0.2);
            position: relative;
        }

        .header h1 {
            color: #3b82f6;
            margin-bottom: 10px;
            font-size: 2.5em;
            font-weight: 700;
            display: inline-block;
        }
        
        /* Estilos para los nuevos botones de encabezado */
        .header-buttons {
            margin-top: 15px;
            margin-bottom: 10px; /* Espacio entre los botones y el siguiente contenido */
            display: flex;
            justify-content: center;
            gap: 10px; /* Espacio entre los botones */
            flex-wrap: wrap; /* Para que se ajusten en pantallas peque√±as */
        }

        .header-button {
            background: #10b981;
            color: white;
            padding: 8px 15px;
            border-radius: 5px;
            font-size: 15px;
            font-weight: 500;
            cursor: pointer;
            border: none;
            transition: background 0.2s;
            display: inline-flex; /* Para alinear el icono y el texto */
            align-items: center;
            gap: 5px; /* Espacio entre icono y texto */
        }

        .header-button:hover:not(:disabled) {
            background: #059669;
        }
        
        .header-button:disabled {
            background: #475569;
            cursor: not-allowed;
            opacity: 0.7;
        }

        #shareButton {
            background: #6b7280; /* Un color secundario para el bot√≥n de compartir */
        }

        #shareButton:hover:not(:disabled) {
            background: #4b5563;
        }

        #statusMessage {
            padding: 10px; 
            margin: 10px auto; 
            border-radius: 8px; 
            font-weight: 600; 
            display: none; 
            transition: all 0.3s ease;
            max-width: 600px;
        }

        .top-banner { /* Este estilo ya no se usar√°, pero lo dejo por si acaso */
            background: #f59e0b;
            color: #1e293b;
            padding: 15px 20px;
            border-radius: 10px;
            margin-bottom: 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            font-weight: 600;
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.2);
        }

        .btn-dismiss { /* Este estilo ya no se usar√° */
            background: transparent;
            border: none;
            color: #1e293b;
            font-size: 1.2em;
            cursor: pointer;
            opacity: 0.8;
            transition: opacity 0.2s;
            padding: 0 10px;
        }

        .btn-dismiss:hover {
            opacity: 1;
        }

        .portfolio-summary {
            display: flex;
            justify-content: center;
            flex-wrap: wrap;
            gap: 15px;
            margin-top: 20px;
            margin-bottom: 20px;
        }

        .summary-card {
            background: rgba(30, 41, 59, 0.6);
            padding: 15px;
            border-radius: 10px;
            border: 1px solid rgba(71, 85, 105, 0.3);
            text-align: center;
            flex: 1 1 200px;
            min-width: 180px;
        }

        .summary-card .label {
            font-size: 14px;
            color: #94a3b8;
            margin-bottom: 5px;
        }

        .summary-card .value {
            font-size: 1.5em;
            font-weight: 600;
            color: #e2e8f0;
        }
        
        .positive-gain {
            color: #10b981;
        }

        .negative-gain {
            color: #ef4444;
        }

        .dollar-widget {
            margin-top: 20px;
            padding: 15px;
            background: rgba(16, 185, 129, 0.1);
            border: 1px solid rgba(16, 185, 129, 0.2);
            border-radius: 10px;
            position: relative;
        }

        .dollar-widget h3 {
            color: #10b981;
            margin-bottom: 15px;
            font-size: 1.2em;
        }

        .dollar-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 10px;
            margin-bottom: 10px;
        }

        .dollar-card {
            background: rgba(30, 41, 59, 0.6);
            padding: 12px;
            border-radius: 8px;
            border: 1px solid rgba(71, 85, 105, 0.3);
            text-align: center;
        }

        .dollar-card .name {
            font-size: 12px;
            color: #94a3b8;
            font-weight: 500;
            margin-bottom: 4px;
        }

        .dollar-card .buy,
        .dollar-card .sell {
            font-size: 14px;
            font-weight: 600;
            margin: 2px 0;
        }

        .dollar-card .buy {
            color: #10b981;
        }

        .dollar-card .sell {
            color: #f59e0b;
        }

        .btn-refresh {
            position: absolute;
            top: 15px;
            right: 15px;
            background: rgba(16, 185, 129, 0.2);
            border: 1px solid rgba(16, 185, 129, 0.3);
            color: #10b981;
            padding: 5px 8px;
            border-radius: 5px;
            cursor: pointer;
            font-size: 12px;
            transition: all 0.3s ease;
        }

        .btn-refresh:hover {
            background: rgba(16, 185, 129, 0.3);
        }

        .loading {
            text-align: center;
            color: #94a3b8;
            font-style: italic;
            padding: 20px;
        }

        .last-update {
            font-size: 11px;
            color: #64748b;
            text-align: center;
            margin-top: 5px;
        }

        .nav-tabs {
            display: flex;
            gap: 10px;
            margin-bottom: 30px;
            flex-wrap: wrap;
        }

        .nav-tab {
            padding: 12px 24px;
            background: rgba(59, 130, 246, 0.1);
            border: 2px solid rgba(59, 130, 246, 0.3);
            border-radius: 10px;
            color: #e2e8f0;
            cursor: pointer;
            transition: all 0.3s ease;
            font-weight: 500;
        }

        .nav-tab:hover {
            background: rgba(59, 130, 246, 0.2);
            border-color: #3b82f6;
        }

        .nav-tab.active {
            background: #3b82f6;
            border-color: #3b82f6;
            color: white;
        }

        .tab-content {
            display: none;
            background: rgba(30, 41, 59, 0.8);
            border-radius: 15px;
            padding: 30px;
            backdrop-filter: blur(10px);
            border: 1px solid rgba(71, 85, 105, 0.3);
        }

        .tab-content.active {
            display: block;
        }

        .form-group {
            margin-bottom: 20px;
        }

        .form-group label {
            display: block;
            margin-bottom: 8px;
            color: #94a3b8;
            font-weight: 500;
        }

        .form-group input,
        .form-group select,
        .form-group textarea {
            width: 100%;
            padding: 12px;
            border: 2px solid rgba(71, 85, 105, 0.3);
            border-radius: 8px;
            background: rgba(30, 41, 59, 0.7);
            color: #e2e8f0;
            font-size: 16px;
            transition: border-color 0.3s ease;
        }

        .form-group input:focus,
        .form-group select:focus,
        .form-group textarea:focus {
            outline: none;
            border-color: #3b82f6;
        }

        .form-row {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
        }

        .btn {
            padding: 12px 24px;
            background: #3b82f6;
            color: white;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-size: 16px;
            font-weight: 500;
            transition: all 0.3s ease;
            margin-right: 10px;
            margin-bottom: 10px;
        }

        .btn:hover {
            background: #2563eb;
            transform: translateY(-2px);
        }

        .btn-secondary {
            background: #6b7280;
        }

        .btn-secondary:hover {
            background: #4b5563;
        }

        .btn-danger {
            background: #ef4444;
        }

        .btn-danger:hover {
            background: #dc2626;
        }

        .portfolio-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .portfolio-card {
            background: rgba(59, 130, 246, 0.1);
            border: 1px solid rgba(59, 130, 246, 0.2);
            border-radius: 15px;
            padding: 20px;
            backdrop-filter: blur(10px);
        }

        .portfolio-card h3 {
            color: #3b82f6;
            margin-bottom: 10px;
        }

        .stock-search {
            position: relative;
        }

        .stock-suggestions {
            position: absolute;
            top: 100%;
            left: 0;
            right: 0;
            background: rgba(30, 41, 59, 0.95);
            border: 1px solid rgba(71, 85, 105, 0.3);
            border-radius: 8px;
            max-height: 200px;
            overflow-y: auto;
            z-index: 1000;
            display: none;
        }

        .stock-suggestion {
            padding: 10px;
            cursor: pointer;
            border-bottom: 1px solid rgba(71, 85, 105, 0.2);
        }

        .stock-suggestion:hover {
            background: rgba(59, 130, 246, 0.2);
        }

        .stock-suggestion:last-child {
            border-bottom: none;
        }

        .transactions-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 20px;
            background: rgba(30, 41, 59, 0.8);
            border-radius: 10px;
            overflow: hidden;
        }

        .transactions-table th,
        .transactions-table td {
            padding: 10px 8px;
            text-align: left;
            border-bottom: 1px solid rgba(71, 85, 105, 0.3);
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            font-size: 14px;
        }

        .transactions-table th {
            background: rgba(59, 130, 246, 0.2);
            color: #3b82f6;
            font-weight: 600;
        }

        .install-prompt { /* Este estilo ya no se usar√° */
            position: fixed;
            top: 20px;
            right: 20px;
            background: #3b82f6;
            color: white;
            padding: 15px 20px;
            border-radius: 10px;
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.3);
            display: none;
            z-index: 2000;
            animation: slideIn 0.3s ease-out;
        }

        @keyframes slideIn {
            from {
                transform: translateX(100%);
                opacity: 0;
            }
            to {
                transform: translateX(0);
                opacity: 1;
            }
        }

        .install-prompt button { /* Este estilo ya no se usar√° */
            margin-left: 10px;
            padding: 5px 10px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
        }

        .scrollable-table {
            overflow-x: auto;
            margin-top: 20px;
        }

        .ai-chat {
            height: 500px;
            display: flex;
            flex-direction: column;
        }

        .chat-messages {
            flex-grow: 1;
            overflow-y: auto;
            padding: 10px;
            background: rgba(30, 41, 59, 0.6);
            border-radius: 10px;
            margin-bottom: 10px;
        }

        .chat-input {
            display: flex;
        }

        .chat-input input {
            flex-grow: 1;
            border-top-right-radius: 0;
            border-bottom-right-radius: 0;
        }

        .chat-input button {
            border-top-left-radius: 0;
            border-bottom-left-radius: 0;
        }

        .message {
            margin-bottom: 10px;
            padding: 8px 12px;
            border-radius: 15px;
            word-wrap: break-word;
        }

        .user-message {
            background: #3b82f6;
            margin-left: auto;
            max-width: 80%;
        }

        .ai-message {
            background: #475569;
            margin-right: auto;
            max-width: 80%;
        }
        
        .transaction-filters {
            display: flex;
            gap: 15px;
            margin-bottom: 20px;
            flex-wrap: wrap;
            align-items: center;
            position: relative; /* Para posicionar el dropdown relativo a este contenedor */
        }

        .search-input {
            flex: 1;
            min-width: 200px;
            padding: 10px;
            border: 2px solid rgba(71, 85, 105, 0.3);
            border-radius: 8px;
            background: rgba(30, 41, 59, 0.7);
            color: #e2e8f0;
            font-size: 14px;
        }

        .search-input:focus {
            outline: none;
            border-color: #3b82f6;
        }


        @media (max-width: 768px) {
            .container {
                padding: 10px;
            }

            .header h1 {
                font-size: 2em;
            }

            .header h1 {
                display: block;
                margin: 5px auto;
            }
            .header-buttons {
                flex-direction: column; /* Apila los botones en m√≥viles */
                align-items: center;
            }
            .header-button {
                width: 100%; /* Los botones ocupan todo el ancho */
            }

            .dollar-grid {
                grid-template-columns: repeat(2, 1fr);
            }

            .dollar-widget {
                padding: 10px;
            }

            .nav-tabs {
                justify-content: center;
            }

            .nav-tab {
                flex: 1;
                text-align: center;
                min-width: 120px;
            }

            .form-row {
                grid-template-columns: 1fr;
            }

            .transactions-table {
                font-size: 10px;
            }

            .transactions-table th,
            .transactions-table td {
                padding: 6px 3px;
            }

            .transaction-filters {
                flex-direction: column;
                align-items: stretch;
            }

            .search-input {
                min-width: 100%;
            }
            
            #columnCustomizationDropdown {
                /* Para m√≥vil, que el dropdown ocupe el ancho y se vea mejor */
                width: 100% !important; 
                right: 0 !important;
                left: 0 !important;
            }
        }
    </style>
</head>
<body>
    <!-- El installPrompt ya no es necesario como banner flotante --><div class="container">
        <!-- El topBanner ha sido removido --><div id="statusMessage" style="padding: 10px; margin: 10px auto; border-radius: 8px; font-weight: 600; display: none; transition: all 0.3s ease;"></div>

        <header class="header">
            <h1 style="display: inline-block;">üìà GuiarCapital</h1>
            <p>Gestiona tus inversiones y portafolios de manera profesional</p>
            
            <div class="header-buttons">
                <button id="installButton" class="header-button" onclick="installApp()" title="Instalar como App o Acceso Directo" style="display: none;">
                    ‚¨áÔ∏è Instalar App
                </button>
                <button id="shareButton" class="header-button" onclick="shareApp()" title="Compartir aplicaci√≥n" style="display: none;">
                    üîó Compartir
                </button>
            </div>
            
            <div id="dollarRates" class="dollar-widget">
                <h3>üíµ Cotizaciones del D√≥lar</h3>
                <div class="dollar-grid" id="dollarGrid">
                    <div class="loading">Cargando cotizaciones...</div>
                </div>
                <button class="btn-refresh" onclick="loadDollarRates()" title="Actualizar cotizaciones">üîÑ</button>
            </div>
            
            <div id="watchlistWidget" class="dollar-widget" style="background: rgba(59, 130, 246, 0.1); border: 1px solid rgba(59, 130, 246, 0.2); margin-top: 20px;">
                <h3 style="color: #3b82f6;">‚≠ê Buscador y Favoritos</h3>
                
                <div class="form-group stock-search" style="margin-bottom: 10px;">
                    <input type="text" id="watchlistSymbolSearch" placeholder="Buscar Ticker (Ej: AAPL, GGAL) y presionar ENTER para a√±adir" oninput="searchWatchlistStocks(this.value)" onkeypress="if(event.key === 'Enter') addFavoriteFromSearch()">
                    <div id="watchlistSuggestions" class="stock-suggestions" style="top: 90%;"></div>
                </div>

                <div id="favoritesList" class="dollar-grid" style="grid-template-columns: repeat(auto-fit, minmax(280px, 1fr)); gap: 15px;">
                    <div class="loading" id="favoritesLoading">Cargando favoritos...</div>
                </div>
            </div>

            <div id="portfolioSummary" class="portfolio-summary">
                <div class="summary-card">
                    <div class="label">Saldo Total $</div>
                    <div class="value" id="balanceArs">Cargando...</div>
                </div>
                <div class="summary-card">
                    <div class="label">Ganancia $</div>
                    <div class="value" id="gainArs">Cargando...</div>
                </div>
                <div class="summary-card">
                    <div class="label">Saldo Total USD</div>
                    <div class="value" id="balanceUsd">Cargando...</div>
                </div>
                <div class="summary-card">
                    <div class="label">Ganancia USD</div>
                    <div class="value" id="gainUsd">Cargando...</div>
                </div>
            </div>
        </header>

        <nav class="nav-tabs">
            <div class="nav-tab active" onclick="showTab('portfolios', this)">Portafolios</div>
            <div class="nav-tab" onclick="showTab('transaction', this)">Nueva Transacci√≥n</div>
            <div class="nav-tab" onclick="showTab('transactions', this)">Ver Transacciones</div>
            <div class="nav-tab" onclick="showTab('export', this)">Exportar</div>
            <div class="nav-tab" onclick="showTab('aiAssistant', this)">Asistente AI</div>
        </nav>

        <div id="portfolios" class="tab-content active">
            <h2>Gesti√≥n de Portafolios</h2>
            
            <div class="form-group">
                <label>Crear Nuevo Portafolio</label>
                <div class="form-row">
                    <input type="text" id="portfolioName" placeholder="Nombre del portafolio">
                    <input type="text" id="portfolioBroker" placeholder="Broker">
                    <button class="btn" onclick="createPortfolio()">Crear</button>
                </div>
            </div>

            <div id="portfoliosList" class="portfolio-grid"></div>

            <h2 style="color: #3b82f6; margin-top: 30px; margin-bottom: 20px;">Posiciones Actuales y Precios en Vivo</h2>
            
            <div class="scrollable-table">
                <table id="holdingsTable" class="transactions-table">
                    <thead>
                        <tr>
                            <th>Ticker</th>
                            <th>Tipo</th>
                            <th>Cantidad</th>
                            <th>Costo Prom. ($)</th>
                            <th>Precio Subyacente (USD)</th>
                            <th>Precio CEDEAR/Acc. (USD)</th> 
                            <th>Precio CEDEAR/Acc. ($ Impl√≠cito)</th>
                            <th>Valor Actual ($)</th>
                            <th>Ganancia/P√©rdida ($)</th>
                        </tr>
                    </thead>
                    <tbody></tbody>
                </table>
            </div>

            <div class="form-group" style="margin-top: 30px;">
                <label>Ver Transacciones de:</label>
                <select id="portfolioFilter" onchange="filterTransactions()">
                    <option value="all">Todas las carteras</option>
                </select>
            </div>
        </div>

        <div id="transaction" class="tab-content">
            <h2>Registrar Nueva Transacci√≥n</h2>
            
            <form onsubmit="addTransaction(event)">
                <div class="form-row">
                    <div class="form-group">
                        <label>Portafolio</label>
                        <select id="transactionPortfolio" required>
                            <option value="">Seleccionar portafolio</option>
                        </select>
                    </div>
                    
                    <div class="form-group stock-search">
                        <label>Ticker/S√≠mbolo</label>
                        <input type="text" id="stockSymbol" placeholder="Ej: GGAL, YPFD, ALUA" required oninput="searchStocks(this.value)" autocomplete="off">
                        <div id="stockSuggestions" class="stock-suggestions"></div>
                    </div>
                </div>

                <div class="form-row">
                    <div class="form-group">
                        <label>Tipo</label>
                        <select id="transactionType" required>
                            <option value="compra">Compra</option>
                            <option value="venta">Venta</option>
                        </select>
                    </div>
                    
                    <div class="form-group">
                        <label>Tipo de Activo</label>
                        <select id="assetType" required>
                            <option value="accion">Acci√≥n</option>
                            <option value="cedear">CEDEAR</option>
                        </select>
                    </div>
                </div>

                <div class="form-row">
                    <div class="form-group">
                        <label>Precio por acci√≥n</label>
                        <input type="number" id="stockPrice" step="0.01" required placeholder="0.00">
                    </div>
                    
                    <div class="form-group">
                        <label>Moneda</label>
                        <select id="currency" required>
                            <option value="ARS">$ (Pesos)</option> 
                            <option value="USD">USD (D√≥lares)</option>
                        </select>
                    </div>
                </div>

                <div class="form-row">
                    <div class="form-group">
                        <label>Cantidad</label>
                        <input type="number" id="quantity" required placeholder="100">
                    </div>
                    
                    <div class="form-group">
                        <label>Fecha</label>
                        <input type="date" id="transactionDate" required>
                    </div>
                </div>

                <div class="form-group">
                    <label>Notas (opcional)</label>
                    <textarea id="notes" rows="3" placeholder="Comentarios adicionales..."></textarea>
                </div>

                <button type="submit" class="btn">Registrar Transacci√≥n</button>
            </form>
        </div>

        <div id="transactions" class="tab-content">
            <h2>Historial de Transacciones</h2>
            
            <div class="transaction-filters">
                <input type="text" id="searchTicker" class="search-input" placeholder="Buscar por Ticker..." oninput="filterTransactions()">
                <select id="portfolioFilterTransactions" onchange="filterTransactions()">
                    <option value="all">Todas las carteras</option>
                </select>
                <!-- BOT√ìN PARA PERSONALIZAR COLUMNAS --><button class="btn btn-secondary" onclick="toggleColumnCustomization(event)" style="flex-shrink: 0;">
                    ‚öôÔ∏è Personalizar Columnas
                </button>
                
                <!-- DROPDOWN DE PERSONALIZACI√ìN --><div id="columnCustomizationDropdown" class="dollar-widget" style="display: none; position: absolute; z-index: 100; padding: 15px; top: 50px; right: 0; width: 300px; background: rgba(30, 41, 59, 1); border: 1px solid #3b82f6; box-shadow: 0 4px 12px rgba(0,0,0,0.5);">
                    <h4 style="color: #e2e8f0; margin-bottom: 10px; font-weight: 600;">Columnas Visibles</h4>
                    <div id="columnCheckboxes" style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px; font-size: 14px;">
                        <!-- Checkboxes will be rendered here by JS --></div>
                    <!-- El bot√≥n de cerrar es √∫til, pero al ocultar por click fuera ya funciona --></div>
            </div>

            <div class="scrollable-table">
                <table id="transactionsTable" class="transactions-table">
                    <thead>
                        <!-- Headers are generated dynamically --></thead>
                    <tbody></tbody>
                </table>
            </div>
        </div>

        <div id="export" class="tab-content">
            <h2>Exportar Datos</h2>
            
            <div class="form-group">
                <p>Exporta todas tus transacciones a formato Excel (.xlsx) para an√°lisis externo.</p>
                <button class="btn" onclick="exportToExcel()">üìä Exportar a Excel</button>
                <button class="btn btn-secondary" onclick="exportToJSON()">üìÑ Exportar JSON</button>
            </div>

            <div class="form-group">
                <label>Importar datos desde JSON</label>
                <input type="file" id="importFile" accept=".json" onchange="importFromJSON(event)">
            </div>
        </div>

        <div id="aiAssistant" class="tab-content">
            <h2>Asistente de Inversi√≥n IA</h2>
            <p style="color:#94a3b8; margin-bottom: 20px;">
                Pregunta al asistente sobre tu portafolio o sobre t√©rminos financieros. Por ejemplo: "¬øCu√°l es mi ganancia total?", "¬øQu√© es un CEDEAR?".
            </p>
            
            <div class="form-group" style="border-bottom: 1px solid rgba(71, 85, 105, 0.3); padding-bottom: 20px;">
                <button class="btn" onclick="generateAudioSummary()">‚ú® Resumen de Portafolio por Voz</button>
            </div>

            <div class="ai-chat">
                <div id="chatMessages" class="chat-messages">
                    <div class="message ai-message">
                        ¬°Hola! Soy tu asistente de inversi√≥n. ¬øEn qu√© puedo ayudarte hoy?
                    </div>
                </div>
                <div class="chat-input">
                    <input type="text" id="aiInput" placeholder="Escribe tu pregunta aqu√≠..." onkeypress="if(event.key === 'Enter') sendAIChat()">
                    <button class="btn" onclick="sendAIChat()">Enviar</button>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Variables y Configuraci√≥n
        let portfolios = JSON.parse(localStorage.getItem('portfolios') || '[]');
        let transactions = JSON.parse(localStorage.getItem('transactions') || '[]');
        let favorites = JSON.parse(localStorage.getItem('favorites') || '[]');
        let deferredPrompt; // Variable para almacenar el evento beforeinstallprompt
        let dollarRates = {};
        let stockPricesCache = {};
        const ALPHA_VANTAGE_API_KEY = '1RW4YGC5ZFFQHGA6';
        
        // --- NUEVA ESTRUCTURA DE COLUMNAS (Total 14 posibles) ---
        const defaultTransactionColumns = [
            { id: 'date', title: 'Fecha', visible: true },
            { id: 'portfolioName', title: 'Portafolio', visible: true },
            { id: 'symbol', title: 'Ticker', visible: true },
            { id: 'type', title: 'Tipo (C/V)', visible: true },
            { id: 'assetType', title: 'Tipo de Activo', visible: false },
            { id: 'price', title: 'Precio Transacci√≥n', visible: true },
            { id: 'currency', title: 'Moneda', visible: false },
            { id: 'quantity', title: 'Cantidad', visible: true },
            { id: 'notes', title: 'Notas', visible: false },
            // Columnas de valor actual (Live)
            { id: 'livePrice', title: 'Precio Actual ($ Unidad)', visible: true },
            { id: 'liveValue', title: 'Valor Actual ($ Total)', visible: true },
            { id: 'gainArs', title: 'Ganancia/P√©rdida ($)', visible: true },
            { id: 'gainPercent', title: '% Ganancia', visible: true },
            { id: 'actions', title: 'Acciones', visible: true }
        ];

        // Cargar el estado de las columnas desde localStorage o usar el default
        let transactionColumns = loadColumnState();

        function loadColumnState() {
            try {
                const savedState = JSON.parse(localStorage.getItem('transactionColumns'));
                if (savedState && Array.isArray(savedState)) {
                    // Merge para mantener las columnas nuevas/por defecto si el usuario nunca guard√≥
                    const mergedState = defaultTransactionColumns.map(defaultCol => {
                        const savedCol = savedState.find(c => c.id === defaultCol.id);
                        // Usar la visibilidad guardada si existe, sino usar la visibilidad por defecto
                        return savedCol ? { ...defaultCol, visible: savedCol.visible } : defaultCol;
                    });
                    return mergedState;
                }
            } catch (e) {
                console.error("Error cargando estado de columnas:", e);
            }
            return defaultTransactionColumns;
        }

        // --- L√≥gica de Columnas (Nueva) ---

        function toggleColumnCustomization(event) {
            event.stopPropagation();
            const dropdown = document.getElementById('columnCustomizationDropdown');
            const isVisible = dropdown.style.display === 'block';

            if (!isVisible) {
                renderColumnCheckboxes();
                dropdown.style.display = 'block';
            } else {
                dropdown.style.display = 'none';
            }
        }

        function renderColumnCheckboxes() {
            const container = document.getElementById('columnCheckboxes');
            let html = '';

            transactionColumns.forEach(col => {
                // Excluir la columna de Acciones (siempre debe ser visible para eliminar)
                if (col.id === 'actions') return;

                html += `
                    <div style="display: flex; align-items: center;">
                        <input type="checkbox" id="col-${col.id}" 
                               ${col.visible ? 'checked' : ''} 
                               onchange="handleColumnChange('${col.id}', this.checked)"
                               style="margin-right: 5px;">
                        <label for="col-${col.id}" style="margin: 0; color: #a5b4fc; cursor: pointer;">${col.title}</label>
                    </div>
                `;
            });

            container.innerHTML = html;
        }

        function handleColumnChange(columnId, isVisible) {
            const index = transactionColumns.findIndex(c => c.id === columnId);
            if (index !== -1) {
                transactionColumns[index].visible = isVisible;
                saveColumnState();
                filterTransactions(); // Refrescar la tabla de transacciones
            }
        }
        
        function saveColumnState() {
            localStorage.setItem('transactionColumns', JSON.stringify(transactionColumns));
            saveData(); // Llama a la funci√≥n principal de guardar datos
        }

        // Cerrar el dropdown de columnas al hacer clic fuera (Actualizaci√≥n global)
        document.addEventListener('click', (e) => {
            const dropdown = document.getElementById('columnCustomizationDropdown');
            const button = document.querySelector('.transaction-filters .btn-secondary');

            if (dropdown && dropdown.style.display === 'block' && 
                !dropdown.contains(e.target) && e.target !== button) {
                dropdown.style.display = 'none';
            }
            
            // Cierre de sugerencias de tickers
            if (!e.target.closest('#transaction .stock-search')) {
                document.getElementById('stockSuggestions').style.display = 'none';
            }
            if (!e.target.closest('#watchlistWidget .stock-search')) {
                 document.getElementById('watchlistSuggestions').style.display = 'none';
            }
        });


        // CEDEARRs y Stocks (Mantenidos)
        const cedearsRatios = {
            'AAPL': 10, 'MELI': 2, 'TSLA': 15, 'GOOGL': 20, 'MSFT': 8, 'AMZN': 72, 
            'BABA': 9, 'NVDA': 24, 'XOM': 6, 'WMT': 12, 'KO': 1, 'MCD': 6, 'MMM': 6,
            'JPM': 6, 'BAC': 6, 'WFC': 30, 'C': 30, 'AXP': 10, 'VISA': 10, 'MA': 2,
            'NFLX': 2, 'INTC': 20, 'CSCO': 10, 'IBM': 2, 'ORCL': 10, 'SAP': 10,
            'PFE': 10, 'MRK': 10, 'JNJ': 5, 'ABBV': 5, 'LLY': 1, 'UNH': 5, 'PG': 5,
            'SBUX': 4, 'BBY': 4, 'T': 20, 'VZ': 20, 'TM': 2, 'KO': 1, 'PEP': 1,
            'NKE': 4, 'ADBE': 12, 'PYPL': 15, 'CRM': 15, 'DISN': 8, 'AMD': 10,
            'EBAY': 12, 'WBA': 10, 'MDLZ': 10, 'BA': 10
        };

        const argentineStocks = [
            { symbol: 'GGAL', name: 'Grupo Galicia' }, { symbol: 'YPFD', name: 'YPF' },
            { symbol: 'ALUA', name: 'Aluar' }, { symbol: 'BBAR', name: 'Banco BBVA' },
            { symbol: 'BMA', name: 'Banco Macro' }, { symbol: 'BYMA', name: 'Bolsas y Mercados' },
            { symbol: 'CEPU', name: 'Central Puerto' }, { symbol: 'CRES', name: 'Cresud' },
            { symbol: 'EDN', name: 'Edenor' }, { symbol: 'FRAN', name: 'Fran' },
            { symbol: 'SUPV', name: 'Grupo Supervielle' }, { symbol: 'TECO2', name: 'Telecom' },
        ];
        
        const allAvailableSymbols = [
            ...argentineStocks.map(s => ({ symbol: s.symbol, name: s.name })),
            ...Object.keys(cedearsRatios).map(symbol => ({ symbol: symbol, name: symbol }))
        ];
        
        // --- Funciones de Utilidad (Mantenidas) ---

        // La funci√≥n dismissBanner ya no es necesaria
        
        function showCustomAlert(message, type = 'alert') {
            const statusElement = document.getElementById('statusMessage');
            if (!statusElement) {
                console.error(`[ALERTA] ${message}`);
                return;
            }

            let bgColor = '#ef4444';
            if (type === 'info') bgColor = '#3b82f6';
            if (type === 'success') bgColor = '#10b981';
            if (type === 'loading') bgColor = '#f59e0b';

            statusElement.style.backgroundColor = bgColor;
            statusElement.style.color = 'white';
            statusElement.innerText = message;
            statusElement.style.display = 'block';

            setTimeout(() => {
                statusElement.style.display = 'none';
            }, 4000);
        }

        async function loadDollarRates() {
            const dollarGrid = document.getElementById('dollarGrid');
            dollarGrid.innerHTML = '<div class="loading">Actualizando cotizaciones...</div>';
            
            try {
                const endpoints = [
                    { name: 'Oficial', url: 'https://dolarapi.com/v1/dolares/oficial' },
                    { name: 'Blue', url: 'https://dolarapi.com/v1/dolares/blue' },
                    { name: 'MEP', url: 'https://dolarapi.com/v1/dolares/bolsa' },
                    { name: 'CCL', url: 'https://dolarapi.com/v1/dolares/contadoconliqui' }
                ];
                
                const promises = endpoints.map(async endpoint => {
                    try {
                        const response = await fetch(endpoint.url);
                        if (!response.ok) throw new Error('Error en la respuesta');
                        const data = await response.json();
                        return { name: endpoint.name, data };
                    } catch (error) {
                        console.error(`Error cargando ${endpoint.name}:`, error);
                        return { name: endpoint.name, data: null };
                    }
                });
                
                const results = await Promise.all(promises);
                
                let gridHTML = '';
                let validRates = 0;
                
                results.forEach(result => {
                    if (result.data) {
                        validRates++;
                        dollarRates[result.name.toLowerCase()] = result.data;
                        gridHTML += `
                            <div class="dollar-card">
                                <div class="name">${result.name}</div>
                                <div class="buy">C: $${result.data.compra ? result.data.compra.toFixed(2) : 'N/D'}</div>
                                <div class="sell">V: $${result.data.venta ? result.data.venta.toFixed(2) : 'N/D'}</div>
                            </div>
                        `;
                    }
                });
                
                if (validRates === 0) {
                    gridHTML = '<div class="loading">‚ö†Ô∏è Error al cargar cotizaciones</div>';
                } else {
                    const lastUpdate = new Date().toLocaleString('es-AR');
                    gridHTML += `<div class="last-update">Actualizado: ${lastUpdate}</div>`;
                }
                
                dollarGrid.innerHTML = gridHTML;
                
                calculateAndDisplaySummary();
                displayHoldings();
                displayFavorites();
                // Si la pesta√±a de transacciones est√° activa, refrescar
                if (document.querySelector('.tab-content.active').id === 'transactions') {
                    filterTransactions();
                }

            } catch (error) {
                console.error('Error general cargando cotizaciones:', error);
                dollarGrid.innerHTML = '<div class="loading">‚ö†Ô∏è Sin conexi√≥n a internet</div>';
            }
        }
        
        function convertCurrency(amount, fromCurrency, toCurrency, rateType = 'oficial') {
            if (fromCurrency === toCurrency) return amount;
            
            const rate = dollarRates[rateType];
            if (!rate) return amount; 
            
            if (fromCurrency === 'USD' && toCurrency === 'ARS') {
                return amount * (rate.venta || rate.compra || 1);
            } else if (fromCurrency === 'ARS' && toCurrency === 'USD') {
                return amount / (rate.compra || rate.venta || 1);
            }
            
            return amount;
        }

        async function fetchStockPriceWithRetry(symbol, retries = 3, delay = 1000) {
            const isArgentineStock = argentineStocks.some(s => s.symbol === symbol);
            
            if (isArgentineStock) {
                 return null;
            }

            if (stockPricesCache[symbol]) {
                return stockPricesCache[symbol];
            }
            
            const apiUrl = `https://www.alphavantage.co/query?function=GLOBAL_QUOTE&symbol=${symbol}&apikey=${ALPHA_VANTAGE_API_KEY}`;
            
            for (let i = 0; i < retries; i++) {
                try {
                    const response = await fetch(apiUrl);
                    if (!response.ok) {
                        throw new Error(`Alpha Vantage API error: ${response.status}`);
                    }
                    const data = await response.json();
                    
                    if (data['Global Quote'] && data['Global Quote']['05. price']) {
                        const price = parseFloat(data['Global Quote']['05. price']);
                        stockPricesCache[symbol] = price;
                        return price;
                    } else if (data['Note']) {
                        console.warn(`Alpha Vantage rate limit reached. Retrying for ${symbol}...`);
                        await new Promise(resolve => setTimeout(resolve, delay * Math.pow(2, i)));
                    } else {
                        return null; 
                    }
                } catch (error) {
                    console.error(`Error al obtener precio de ${symbol} (intento ${i + 1}):`, error.message);
                    if (i < retries - 1) {
                        await new Promise(resolve => setTimeout(resolve, delay * Math.pow(2, i)));
                    }
                }
            }
            return null;
        }

        async function calculateAndDisplaySummary() {
            const balanceArsElement = document.getElementById('balanceArs');
            const gainArsElement = document.getElementById('gainArs');
            const balanceUsdElement = document.getElementById('balanceUsd');
            const gainUsdElement = document.getElementById('gainUsd');
            
            balanceArsElement.innerText = 'Cargando...';
            gainArsElement.innerText = 'Cargando...';
            balanceUsdElement.innerText = 'Cargando...';
            gainUsdElement.innerText = 'Cargando...';

            let totalBalanceArs = 0;
            let totalCostArs = 0;
            let totalBalanceUsd = 0;
            let totalCostUsd = 0;

            const holdings = {};

            transactions.forEach(t => {
                const isBuy = t.type === 'compra';
                const sign = isBuy ? 1 : -1;

                if (!holdings[t.symbol]) {
                    holdings[t.symbol] = { 
                        quantity: 0, 
                        assetType: t.assetType, 
                        costArs: 0, 
                        costUsd: 0,
                    };
                }
                
                const totalInArs = t.currency === 'ARS' ? t.total : convertCurrency(t.total, 'USD', 'ARS', 'mep');
                const totalInUsd = t.currency === 'USD' ? t.total : convertCurrency(t.total, 'ARS', 'USD', 'mep');
                
                holdings[t.symbol].quantity += sign * t.quantity;
                holdings[t.symbol].costArs += sign * totalInArs;
                holdings[t.symbol].costUsd += sign * totalInUsd;
            });

            const symbolsToFetch = [...new Set(Object.keys(holdings))];
            
            const fetchPromises = symbolsToFetch.map(symbol => {
                const holding = holdings[symbol];
                if (holding.quantity <= 0) return Promise.resolve(null);

                return fetchStockPriceWithRetry(symbol)
                    .then(price => {
                        const mepRate = dollarRates.mep ? (dollarRates.mep.venta || dollarRates.mep.compra || 1) : 1;
                        let currentValueArs = 0;
                        let currentValueUsd = 0;
                        
                        if (price !== null) {
                            const priceSubyacenteUsd = price;

                            if (holding.assetType === 'cedear') {
                                const ratio = cedearsRatios[symbol] || 1;
                                const priceCedearUsd = priceSubyacenteUsd / ratio;
                                currentValueUsd = priceCedearUsd * holding.quantity;
                                currentValueArs = currentValueUsd * mepRate;
                            } else {
                                currentValueArs = (priceSubyacenteUsd * mepRate) * holding.quantity;
                                currentValueUsd = currentValueArs / mepRate;
                            }
                        } else {
                            currentValueArs = holding.costArs;
                            currentValueUsd = holding.costUsd;
                        }
                        
                        totalBalanceArs += currentValueArs;
                        totalBalanceUsd += currentValueUsd;
                        
                        return price;
                    })
                    .catch(() => {
                        if (holding.quantity > 0) {
                            totalBalanceArs += holding.costArs;
                            totalBalanceUsd += holding.costUsd;
                        }
                    });
            });

            await Promise.all(fetchPromises);
            
            Object.values(holdings).forEach(holding => {
                if (holding.quantity <= 0) {
                    totalCostArs += holding.costArs;
                    totalCostUsd += holding.costUsd;
                }
            });

            const totalGainArs = totalBalanceArs - totalCostArs;
            const totalGainUsd = totalBalanceUsd - totalCostUsd;
            
            balanceArsElement.innerText = `$${totalBalanceArs.toFixed(2)}`;
            gainArsElement.innerText = `$${totalGainArs.toFixed(2)}`;
            gainArsElement.classList.toggle('positive-gain', totalGainArs >= 0);
            gainArsElement.classList.toggle('negative-gain', totalGainArs < 0);

            balanceUsdElement.innerText = `U$D${totalBalanceUsd.toFixed(2)}`;
            gainUsdElement.innerText = `U$D${totalGainUsd.toFixed(2)}`;
            gainUsdElement.classList.toggle('positive-gain', totalGainUsd >= 0);
            gainUsdElement.classList.toggle('negative-gain', totalGainUsd < 0);
        }

        async function displayHoldings() {
            const tbody = document.querySelector('#holdingsTable tbody');
            tbody.innerHTML = '<tr><td colspan="9" style="text-align: center;">Cargando tenencias y precios en vivo...</td></tr>';
            
            const holdings = {};
            transactions.forEach(t => {
                const isBuy = t.type === 'compra';
                const sign = isBuy ? 1 : -1;

                if (!holdings[t.symbol]) {
                    holdings[t.symbol] = { quantity: 0, assetType: t.assetType, costArs: 0, costUsd: 0 };
                }

                const totalInArs = t.currency === 'ARS' ? t.total : convertCurrency(t.total, 'USD', 'ARS', 'mep'); 
                
                holdings[t.symbol].quantity += sign * t.quantity;
                holdings[t.symbol].costArs += sign * totalInArs;
            });

            const activeHoldings = Object.entries(holdings).filter(([, h]) => h.quantity > 0);
            
            if (activeHoldings.length === 0) {
                tbody.innerHTML = '<tr><td colspan="9" style="text-align: center;">No tienes posiciones abiertas.</td></tr>';
                return;
            }

            const fetchPromises = activeHoldings.map(([symbol, holding]) => 
                fetchStockPriceWithRetry(symbol)
                    .then(price => ({ symbol, price, holding }))
                    .catch(() => ({ symbol, price: null, holding }))
            );

            const results = await Promise.all(fetchPromises);
            
            let rowsHTML = '';
            const mepRate = dollarRates.mep ? (dollarRates.mep.venta || dollarRates.mep.compra || 1) : 1;

            results.forEach(({ symbol, price: stockPriceUsd, holding }) => {
                if (holding.quantity <= 0) return;
                
                const ratio = cedearsRatios[symbol] || 1;
                const assetType = holding.assetType.toUpperCase();
                
                let priceSubyacenteUsdDisplay = 'N/D';
                let priceUnitUsdDisplay = 'N/D';
                let pricePerUnitArs = null; 
                let currentValueArs = 0;
                let avgCostArs = holding.costArs / holding.quantity;
                
                if (stockPriceUsd !== null) {
                    const priceSubyacenteUsd = stockPriceUsd; 
                    priceSubyacenteUsdDisplay = priceSubyacenteUsd.toFixed(2);

                    const priceUnitUsd = (assetType === 'CEDEAR') ? (priceSubyacenteUsd / ratio) : priceSubyacenteUsd;
                    priceUnitUsdDisplay = priceUnitUsd.toFixed(2);

                    pricePerUnitArs = priceUnitUsd * mepRate;
                    currentValueArs = pricePerUnitArs * holding.quantity;

                } else {
                    pricePerUnitArs = avgCostArs;
                    currentValueArs = holding.costArs;
                }
                
                const gainArs = currentValueArs - holding.costArs;
                const gainClass = gainArs >= 0 ? 'positive-gain' : 'negative-gain';
                
                const pricePerUnitArsDisplay = pricePerUnitArs !== null ? pricePerUnitArs.toFixed(2) : 'N/D';

                rowsHTML += `
                    <tr>
                        <td><strong>${symbol}</strong></td>
                        <td>${assetType}</td>
                        <td>${holding.quantity}</td>
                        <td>$${avgCostArs.toFixed(2)}</td>
                        <td>U$D${priceSubyacenteUsdDisplay}</td>
                        <td>U$D${priceUnitUsdDisplay}</td>
                        <td>$${pricePerUnitArsDisplay}</td>
                        <td>$${currentValueArs.toFixed(2)}</td>
                        <td class="${gainClass}">$${gainArs.toFixed(2)}</td>
                    </tr>
                `;
            });

            tbody.innerHTML = rowsHTML;
        }
        
        // --- Funciones de Favoritos (Mantenidas) ---
        function addFavorite(symbol) {
            symbol = symbol.trim().toUpperCase();
            if (!symbol) return;
            
            if (!allAvailableSymbols.some(s => s.symbol === symbol)) {
                showCustomAlert(`Ticker "${symbol}" no reconocido.`, 'alert');
                return;
            }
            
            if (!favorites.includes(symbol)) {
                favorites.push(symbol);
                localStorage.setItem('favorites', JSON.stringify(favorites));
                displayFavorites();
                showCustomAlert(`"${symbol}" a√±adido a favoritos`, 'success');
            } else {
                showCustomAlert(`"${symbol}" ya est√° en favoritos`, 'info');
            }
        }

        function removeFavorite(symbol) {
            favorites = favorites.filter(s => s !== symbol);
            localStorage.setItem('favorites', JSON.stringify(favorites));
            displayFavorites();
            showCustomAlert(`"${symbol}" eliminado de favoritos`, 'alert');
        }
        
        function addFavoriteFromSearch() {
            const input = document.getElementById('watchlistSymbolSearch');
            const symbol = input.value.trim().toUpperCase();
            if (symbol) {
                addFavorite(symbol);
                input.value = '';
                document.getElementById('watchlistSuggestions').style.display = 'none';
            }
        }

        function searchWatchlistStocks(query) {
            const suggestions = document.getElementById('watchlistSuggestions');
            
            if (!query || query.length < 1) {
                suggestions.style.display = 'none';
                return;
            }

            const matches = allAvailableSymbols.filter(stock => 
                stock.symbol.toLowerCase().startsWith(query.toLowerCase()) ||
                (stock.name && stock.name.toLowerCase().includes(query.toLowerCase()))
            ).slice(0, 5); 

            if (matches.length === 0) {
                suggestions.style.display = 'none';
                return;
            }

            function selectAndAddFavorite(symbol) {
                document.getElementById('watchlistSymbolSearch').value = symbol;
                suggestions.style.display = 'none';
                addFavorite(symbol);
            }
            window.selectAndAddFavorite = selectAndAddFavorite;

            suggestions.innerHTML = matches.map(stock => 
                `<div class="stock-suggestion" onclick="selectAndAddFavorite('${stock.symbol}')">
                    <strong>${stock.symbol}</strong> - ${stock.name}
                </div>`
            ).join('');
            
            suggestions.style.display = 'block';
        }
        
        async function displayFavorites() {
            const favoritesList = document.getElementById('favoritesList');
            
            if (favorites.length === 0) {
                favoritesList.innerHTML = '<p style="text-align: center; color: #94a3b8; grid-column: 1 / -1; padding: 10px 0;">A√±ade tickers para seguirlos en tiempo real (Ej: AAPL, MELI).</p>';
                return;
            }

            favoritesList.innerHTML = '<div class="loading" id="favoritesLoading" style="grid-column: 1 / -1;">Cargando precios en tiempo real... üîÑ</div>';
            
            const symbolsToFetch = [...favorites];
            
            const fetchPromises = symbolsToFetch.map(symbol => 
                fetchStockPriceWithRetry(symbol)
                    .then(price => ({ symbol, price }))
                    .catch(() => ({ symbol, price: null }))
            );

            const results = await Promise.all(fetchPromises);
            
            let cardsHTML = '';
            const mepRate = dollarRates.mep ? (dollarRates.mep.venta || dollarRates.mep.compra || 1) : 1;

            results.forEach(({ symbol, price: stockPriceUsd }) => {
                const assetType = cedearsRatios[symbol] ? 'CEDEAR' : 'ACCI√ìN';
                const ratio = cedearsRatios[symbol] || 1;
                
                let priceSubyacenteUsdDisplay = 'N/D';
                let priceUnitUsdDisplay = 'N/D';
                let pricePerUnitArsDisplay = 'N/D';

                if (stockPriceUsd !== null) {
                    const priceSubyacenteUsd = stockPriceUsd; 
                    priceSubyacenteUsdDisplay = priceSubyacenteUsd.toFixed(2);

                    const priceUnitUsd = (assetType === 'CEDEAR') ? (priceSubyacenteUsd / ratio) : priceSubyacenteUsd;
                    priceUnitUsdDisplay = priceUnitUsd.toFixed(2);

                    const pricePerUnitArs = priceUnitUsd * mepRate;
                    pricePerUnitArsDisplay = pricePerUnitArs.toFixed(2);
                }

                cardsHTML += `
                    <div class="summary-card" style="position: relative; padding-bottom: 35px; border: 1px solid #3b82f6;">
                        <div style="font-size: 1.2em; font-weight: 700; color: #3b82f6; margin-bottom: 5px; display: flex; justify-content: space-between; align-items: center;">
                            <span>${symbol}</span> 
                            <span style="font-size: 0.7em; background: rgba(59, 130, 246, 0.2); padding: 2px 6px; border-radius: 4px; color: #a5b4fc;">${assetType}</span>
                        </div>
                        
                        <div style="display: flex; justify-content: space-between; font-size: 14px; margin-top: 5px;">
                            <span class="label" style="text-align: left;">USD Subyacente:</span>
                            <span class="value" style="font-size: 1.1em; color: #10b981;">U$D${priceSubyacenteUsdDisplay}</span>
                        </div>
                        
                        <div style="display: flex; justify-content: space-between; font-size: 14px; margin-top: 5px;">
                            <span class="label" style="text-align: left;">Precio $ (MEP):</span>
                            <span class="value" style="font-size: 1.1em; color: #f59e0b;">$${pricePerUnitArsDisplay}</span>
                        </div>

                        <button class="btn btn-danger" onclick="removeFavorite('${symbol}')" 
                            style="position: absolute; bottom: 8px; right: 10px; padding: 3px 8px; font-size: 10px; line-height: 1;">
                            ‚ùå
                        </button>
                    </div>
                `;
            });

            favoritesList.innerHTML = cardsHTML;
        }

        // --- PWA, Navegaci√≥n y CRUD B√°sico (Mantenidos) ---

        window.addEventListener('beforeinstallprompt', (e) => {
            e.preventDefault();
            deferredPrompt = e;
            document.getElementById('installButton').style.display = 'inline-flex'; // Mostrar el bot√≥n
        });

        function installApp() {
            if (deferredPrompt) {
                deferredPrompt.prompt();
                deferredPrompt.userChoice.then((choiceResult) => {
                    if (choiceResult.outcome === 'accepted') {
                        showCustomAlert('¬°App instalada con √©xito!', 'success');
                    }
                    deferredPrompt = null;
                    updateInstallButtonState(); // Actualizar el estado del bot√≥n despu√©s de la instalaci√≥n
                });
            } else {
                 showCustomAlert('La instalaci√≥n PWA no est√° disponible o la aplicaci√≥n ya est√° instalada.', 'info');
                 updateInstallButtonState(); // Asegurarse de que el bot√≥n se actualice si ya est√° instalada
            }
        }

        function shareApp() {
            if (navigator.share) {
                navigator.share({
                    title: 'GuiarCapital - Tu gestor de portafolios',
                    text: '¬°Gestiona tus inversiones y portafolios de manera profesional con GuiarCapital!',
                    url: window.location.href,
                }).then(() => {
                    showCustomAlert('¬°Gracias por compartir!', 'success');
                }).catch((error) => {
                    console.error('Error al compartir:', error);
                    showCustomAlert('No se pudo compartir la aplicaci√≥n.', 'alert');
                });
            } else {
                // Fallback para navegadores que no soportan Web Share API
                showCustomAlert('Tu navegador no soporta la funci√≥n de compartir. Puedes copiar el enlace manualmente.', 'info');
                // Opcionalmente, puedes copiar el URL al portapapeles aqu√≠
                navigator.clipboard.writeText(window.location.href).then(() => {
                    showCustomAlert('Enlace copiado al portapapeles!', 'success');
                }).catch(err => {
                    console.error('Error al copiar al portapapeles:', err);
                });
            }
        }

        function updateInstallButtonState() {
             const installBtn = document.getElementById('installButton');
             const shareBtn = document.getElementById('shareButton');

             // Mostrar el bot√≥n de compartir si est√° disponible
             if (navigator.share) {
                 shareBtn.style.display = 'inline-flex';
             } else {
                 shareBtn.style.display = 'none'; // Ocultar si no hay soporte
             }

             // L√≥gica para el bot√≥n de instalaci√≥n
             if (window.matchMedia('(display-mode: standalone)').matches || window.navigator.standalone) {
                 // La aplicaci√≥n est√° instalada (o se lanz√≥ desde el acceso directo)
                 installBtn.innerText = '‚úÖ App Instalada';
                 installBtn.disabled = true;
                 installBtn.style.background = '#475569'; // Cambiar a un color gris
                 installBtn.style.display = 'inline-flex'; // Asegurarse de que est√© visible
                 document.getElementById('installPrompt').style.display = 'none'; // Eliminar el prompt antiguo si todav√≠a exist√≠a
             } else if (deferredPrompt) {
                 // La aplicaci√≥n no est√° instalada, pero es instalable
                 installBtn.innerText = '‚¨áÔ∏è Instalar App';
                 installBtn.disabled = false;
                 installBtn.style.background = '#10b981';
                 installBtn.style.display = 'inline-flex';
             } else {
                 // No instalable o no se ha disparado el prompt
                 installBtn.style.display = 'none';
             }
         }

        function showTab(tabName, element) {
            document.querySelectorAll('.tab-content').forEach(tab => tab.classList.remove('active'));
            document.querySelectorAll('.nav-tab').forEach(tab => tab.classList.remove('active'));
            
            document.getElementById(tabName).classList.add('active');
            if (element) {
                element.classList.add('active');
            }

            // Ocultar el dropdown de personalizaci√≥n al cambiar de pesta√±a
            const dropdown = document.getElementById('columnCustomizationDropdown');
            if (dropdown) dropdown.style.display = 'none';

            if (tabName === 'portfolios') {
                displayPortfolios();
                calculateAndDisplaySummary();
                displayHoldings();
            } else if (tabName === 'transaction') {
                updatePortfolioSelects();
                document.getElementById('transactionDate').valueAsDate = new Date();
            } else if (tabName === 'transactions') {
                updatePortfolioFilterTransactions();
                filterTransactions();
            }
        }

        function createPortfolio() {
            const name = document.getElementById('portfolioName').value.trim();
            const broker = document.getElementById('portfolioBroker').value.trim();
            
            if (!name || !broker) {
                showCustomAlert('Por favor completa todos los campos', 'alert');
                return;
            }

            const portfolio = {
                id: Date.now(),
                name: name,
                broker: broker,
                createdAt: new Date().toISOString()
            };

            portfolios.push(portfolio);
            saveData();
            displayPortfolios();
            updatePortfolioSelects();
            calculateAndDisplaySummary();
            displayHoldings();
            
            document.getElementById('portfolioName').value = '';
            document.getElementById('portfolioBroker').value = '';
            
            showCustomAlert('Portafolio creado exitosamente', 'success');
        }

        function displayPortfolios() {
            const container = document.getElementById('portfoliosList');
            
            if (portfolios.length === 0) {
                container.innerHTML = '<p>No hay portafolios creados. Crea tu primer portafolio para comenzar.</p>';
                return;
            }

            container.innerHTML = portfolios.map(portfolio => {
                const portfolioTransactions = transactions.filter(t => t.portfolioId === portfolio.id);
                const totalTransactions = portfolioTransactions.length;
                
                return `
                    <div class="portfolio-card">
                        <h3>${portfolio.name}</h3>
                        <p><strong>Broker:</strong> ${portfolio.broker}</p>
                        <p><strong>Transacciones:</strong> ${totalTransactions}</p>
                        <p><strong>Creado:</strong> ${new Date(portfolio.createdAt).toLocaleDateString()}</p>
                        <button class="btn btn-danger" onclick="deletePortfolio(${portfolio.id})">Eliminar</button>
                    </div>
                `;
            }).join('');

            updatePortfolioFilter();
        }

        function deletePortfolio(id) {
            // Reemplazo de window.confirm()
            if (confirm('¬øEst√°s seguro de eliminar este portafolio? Se eliminar√°n tambi√©n todas sus transacciones.')) {
                portfolios = portfolios.filter(p => p.id !== id);
                transactions = transactions.filter(t => t.portfolioId !== id);
                saveData();
                displayPortfolios();
                updatePortfolioSelects();
                calculateAndDisplaySummary();
                displayHoldings();
                showCustomAlert('Portafolio eliminado con √©xito', 'success');
            }
        }

        function updatePortfolioSelects() {
            const selects = ['transactionPortfolio'];
            
            selects.forEach(selectId => {
                const select = document.getElementById(selectId);
                select.innerHTML = '<option value="">Seleccionar portafolios</option>';
                
                portfolios.forEach(portfolio => {
                    select.innerHTML += `<option value="${portfolio.id}">${portfolio.name} (${portfolio.broker})</option>`;
                });
            });
        }

        function updatePortfolioFilter() {
            const select = document.getElementById('portfolioFilter');
            select.innerHTML = '<option value="all">Todas las carteras</option>';
            
            portfolios.forEach(portfolio => {
                select.innerHTML += `<option value="${portfolio.id}">${portfolio.name} (${portfolio.broker})</option>`;
            });
        }

        function updatePortfolioFilterTransactions() {
            const select = document.getElementById('portfolioFilterTransactions');
            select.innerHTML = '<option value="all">Todas las carteras</option>';
            
            portfolios.forEach(portfolio => {
                select.innerHTML += `<option value="${portfolio.id}">${portfolio.name} (${portfolio.broker})</option>`;
            });
        }

        function searchStocks(query) {
            const suggestions = document.getElementById('stockSuggestions');
            
            if (!query || query.length < 1) {
                suggestions.style.display = 'none';
                return;
            }

            const matches = allAvailableSymbols.filter(stock => 
                stock.symbol.toLowerCase().startsWith(query.toLowerCase()) ||
                (stock.name && stock.name.toLowerCase().includes(query.toLowerCase()))
            );

            if (matches.length === 0) {
                suggestions.style.display = 'none';
                return;
            }

            suggestions.innerHTML = matches.map(stock => 
                `<div class="stock-suggestion" onclick="selectStock('${stock.symbol}')">
                    <strong>${stock.symbol}</strong> - ${stock.name}
                </div>`
            ).join('');
            
            suggestions.style.display = 'block';
        }

        function selectStock(symbol) {
            document.getElementById('stockSymbol').value = symbol;
            document.getElementById('stockSuggestions').style.display = 'none';
            if (cedearsRatios[symbol]) {
                document.getElementById('assetType').value = 'cedear';
            } else {
                document.getElementById('assetType').value = 'accion';
            }
        }

        function addTransaction(event) {
            event.preventDefault();
            
            const portfolioId = parseInt(document.getElementById('transactionPortfolio').value);
            const symbol = document.getElementById('stockSymbol').value.trim().toUpperCase();
            const type = document.getElementById('transactionType').value;
            const assetType = document.getElementById('assetType').value;
            const price = parseFloat(document.getElementById('stockPrice').value);
            const currency = document.getElementById('currency').value;
            const quantity = parseInt(document.getElementById('quantity').value);
            const date = document.getElementById('transactionDate').value;
            const notes = document.getElementById('notes').value.trim();

            if (!portfolioId || !symbol || isNaN(price) || isNaN(quantity) || !date || price <= 0 || quantity <= 0) {
                showCustomAlert('Por favor completa todos los campos obligatorios correctamente.', 'alert');
                return;
            }

            const portfolio = portfolios.find(p => p.id === portfolioId);
            const total = price * quantity;

            const transaction = {
                id: Date.now(),
                portfolioId: portfolioId,
                portfolioName: portfolio.name,
                broker: portfolio.broker,
                symbol: symbol,
                type: type,
                assetType: assetType,
                price: price,
                currency: currency,
                quantity: quantity,
                total: total,
                date: date,
                notes: notes,
                createdAt: new Date().toISOString()
            };

            transactions.push(transaction);
            saveData();
            
            showCustomAlert('Transacci√≥n registrada exitosamente', 'success');
            document.querySelector('#transaction form').reset();
            document.getElementById('transactionDate').valueAsDate = new Date();
            
            calculateAndDisplaySummary();
            displayHoldings();
        }

        async function filterTransactions() {
            const portfolioId = document.getElementById('portfolioFilterTransactions').value;
            const searchQuery = document.getElementById('searchTicker').value.trim().toUpperCase();

            let filtered = transactions;

            if (portfolioId !== 'all') {
                filtered = filtered.filter(t => t.portfolioId === parseInt(portfolioId));
            }

            if (searchQuery) {
                filtered = filtered.filter(t => t.symbol.includes(searchQuery));
            }

            await displayTransactionsFiltered(filtered);
        }

        // --- FUNCI√ìN CENTRAL MODIFICADA (Generaci√≥n Din√°mica de Tabla) ---
        async function displayTransactionsFiltered(transactionsList) {
            const thead = document.querySelector('#transactionsTable thead');
            const tbody = document.querySelector('#transactionsTable tbody');
            
            const visibleColumns = transactionColumns.filter(c => c.visible);
            const colspan = visibleColumns.length;

            // 1. GENERAR HEADERS DIN√ÅMICAMENTE
            if (colspan > 0) {
                 thead.innerHTML = `
                    <tr>
                        ${visibleColumns.map(col => `<th>${col.title}</th>`).join('')}
                    </tr>
                `;
            } else {
                thead.innerHTML = '<tr><th>No hay columnas seleccionadas. Personaliza la vista.</th></tr>';
            }

            tbody.innerHTML = `<tr><td colspan="${colspan || 1}" style="text-align: center;">Cargando...</td></tr>`;

            if (transactionsList.length === 0) {
                tbody.innerHTML = `<tr><td colspan="${colspan || 1}" style="text-align: center;">No hay transacciones que cumplan los filtros.</td></tr>`;
                return;
            }
            
            // 2. Obtener precios en vivo
            const uniqueSymbols = [...new Set(transactionsList.map(t => t.symbol))];
            const pricesPromises = uniqueSymbols.map(symbol => fetchStockPriceWithRetry(symbol));
            const livePrices = (await Promise.all(pricesPromises)).reduce((acc, price, index) => {
                acc[uniqueSymbols[index]] = price;
                return acc;
            }, {});
            
            const mepRate = dollarRates.mep ? (dollarRates.mep.venta || dollarRates.mep.compra || 1) : 1;
            const getCurrencySymbol = (currency) => currency === 'ARS' ? '$' : 'U$D';

            // 3. GENERAR FILAS DIN√ÅMICAMENTE
            tbody.innerHTML = transactionsList
                .sort((a, b) => new Date(b.date) - new Date(a.date))
                .map(transaction => {
                    const stockPriceUsd = livePrices[transaction.symbol];
                    const ratio = cedearsRatios[transaction.symbol] || 1;
                    const assetType = transaction.assetType.toUpperCase();
                    
                    let priceUnitArsLive = 0;
                    let valueTotalArsLive = 0;
                    let displayGain = 'N/A';
                    let gainClass = '';
                    let gainPercent = 'N/D';
                    let percentClass = '';

                    const costTransactArs = transaction.currency === 'ARS' ? transaction.total : convertCurrency(transaction.total, 'USD', 'ARS', 'mep');

                    // C√°lculo de valor actual y ganancia
                    if (stockPriceUsd !== null) {
                        const priceUnitUsd = (assetType === 'CEDEAR') ? (stockPriceUsd / ratio) : stockPriceUsd;
                        priceUnitArsLive = priceUnitUsd * mepRate;
                        valueTotalArsLive = priceUnitArsLive * transaction.quantity;
                    } else {
                        priceUnitArsLive = transaction.currency === 'ARS' ? transaction.price : convertCurrency(transaction.price, 'USD', 'ARS', 'mep');
                        valueTotalArsLive = priceUnitArsLive * transaction.quantity;
                    }
                    
                    if (transaction.type === 'compra') {
                        const gainArs = valueTotalArsLive - costTransactArs;
                        gainClass = gainArs >= 0 ? 'positive-gain' : 'negative-gain';
                        displayGain = `$${gainArs.toFixed(2)}`;

                        if (costTransactArs > 0) {
                            gainPercent = ((gainArs / costTransactArs) * 100).toFixed(2) + '%';
                            percentClass = gainArs >= 0 ? 'positive-gain' : 'negative-gain';
                        }
                    }

                    // Mapeo de valores para cada columna
                    const columnData = {
                        date: new Date(transaction.date).toLocaleDateString(),
                        portfolioName: transaction.portfolioName,
                        symbol: `<strong>${transaction.symbol}</strong>`,
                        type: `<span style="color: ${transaction.type === 'compra' ? '#10b981' : '#ef4444'}">${transaction.type.toUpperCase()}</span>`,
                        assetType: transaction.assetType.toUpperCase(),
                        price: `${transaction.price.toFixed(2)} ${getCurrencySymbol(transaction.currency)}`,
                        currency: transaction.currency,
                        quantity: transaction.quantity,
                        notes: transaction.notes,
                        livePrice: `$${priceUnitArsLive.toFixed(2)}`,
                        liveValue: `$${valueTotalArsLive.toFixed(2)}`,
                        gainArs: `<span class="${gainClass}">${displayGain}</span>`,
                        gainPercent: `<span class="${percentClass}">${gainPercent}</span>`,
                        actions: `<button class="btn btn-danger" onclick="deleteTransaction(${transaction.id})" style="padding: 5px 10px; font-size: 12px;">Eliminar</button>`
                    };

                    // Renderizar solo las celdas visibles
                    const rowCells = visibleColumns.map(col => `<td>${columnData[col.id]}</td>`).join('');

                    return `<tr>${rowCells}</tr>`;

                }).join('');
        }
        // --- FIN FUNCI√ìN CENTRAL MODIFICADA ---

        function deleteTransaction(id) {
            // Reemplazo de window.confirm()
            if (confirm('¬øEst√°s seguro de eliminar esta transacci√≥n?')) {
                transactions = transactions.filter(t => t.id !== id);
                saveData();
                filterTransactions();
                displayPortfolios();
                calculateAndDisplaySummary();
                displayHoldings();
                showCustomAlert('Transacci√≥n eliminada con √©xito', 'success');
            }
        }

        // --- Funciones AI (Mantenidas) ---

        const chatHistory = [];
        let isAILoading = false;
        const chatMessages = document.getElementById('chatMessages');
        
        async function sendAIChat() {
            const aiInput = document.getElementById('aiInput');
            const userMessage = aiInput.value.trim();
            if (!userMessage || isAILoading) return;
            
            isAILoading = true;
            aiInput.value = '';
            
            appendMessage('user', userMessage);
            const loadingMessage = appendMessage('ai', 'Pensando...');
            
            try {
                const portfolioSummary = await getPortfolioSummaryForAI();
                const prompt = `Act√∫a como un asistente financiero experto. Aqu√≠ est√°n los datos del portafolio del usuario: ${JSON.stringify(portfolioSummary)}. El usuario pregunta: "${userMessage}". Responde de manera concisa y √∫til. Evita frases como "Basado en tu portafolio..." y ve directo al punto.`;
                
                const aiResponse = await getAIResponse(prompt); 
                loadingMessage.innerText = aiResponse;
            } catch (error) {
                console.error("Error al obtener respuesta de la IA:", error);
                loadingMessage.innerText = 'Disculpa, hubo un error al conectar con el asistente. Intenta de nuevo m√°s tarde.';
            } finally {
                isAILoading = false;
            }
        }

        async function getAIResponse(prompt, retries = 3, delay = 1000) {
            const apiKey = "";
            const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${apiKey}`;
            const payload = {
                contents: [{ role: "user", parts: [{ text: prompt }] }],
                tools: [{ "google_search": {} }],
            };
            
            for (let i = 0; i < retries; i++) {
                try {
                    const response = await fetch(apiUrl, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(payload)
                    });
                    
                    if (!response.ok) {
                        const errorData = await response.json();
                        throw new Error(`Error de la API: ${response.status} - ${JSON.stringify(errorData)}`);
                    }
                    
                    const result = await response.json();
                    
                    if (result.candidates && result.candidates.length > 0 && result.candidates[0].content) {
                        return result.candidates[0].content.parts[0].text;
                    } else {
                        throw new Error('Respuesta de la API de Gemini con formato inesperado.');
                    }
                } catch (error) {
                    if (i < retries - 1) {
                        await new Promise(resolve => setTimeout(resolve, delay * Math.pow(2, i)));
                    } else {
                        throw error;
                    }
                }
            }
        }
        
        async function getPortfolioSummaryForAI() {
            const holdingSummary = {};
            
            const uniqueSymbols = [...new Set(transactions.map(t => t.symbol))];
            
            const pricesPromises = uniqueSymbols.map(symbol => 
                fetchStockPriceWithRetry(symbol).then(price => ({ symbol, price }))
            );
            const prices = await Promise.all(pricesPromises);
            const livePrices = prices.reduce((acc, curr) => {
                acc[curr.symbol] = curr.price;
                return acc;
            }, {});

            transactions.forEach(t => {
                const isBuy = t.type === 'compra';
                const sign = isBuy ? 1 : -1;

                if (!holdingSummary[t.symbol]) {
                    holdingSummary[t.symbol] = {
                        symbol: t.symbol,
                        assetType: t.assetType,
                        currency: t.currency,
                        quantity: 0,
                        totalCost: 0,
                    };
                }
                
                const totalInArs = t.currency === 'ARS' ? t.total : convertCurrency(t.total, 'USD', 'ARS', 'mep');
                
                holdingSummary[t.symbol].quantity += sign * t.quantity;
                holdingSummary[t.symbol].totalCost += sign * totalInArs;
            });
            
            const activeHoldings = Object.values(holdingSummary).filter(h => h.quantity > 0);

            for (const holding of activeHoldings) {
                const priceUsd = livePrices[holding.symbol] || 0;
                const mepRate = dollarRates.mep ? (dollarRates.mep.venta || dollarRates.mep.compra || 1) : 1;
                
                let currentPriceArs = 0;
                
                if (holding.assetType === 'cedear') {
                    const ratio = cedearsRatios[holding.symbol] || 1;
                    currentPriceArs = (priceUsd / ratio) * mepRate;
                } else {
                    currentPriceArs = priceUsd * mepRate;
                }
                
                holding.avgCostArs = holding.totalCost / holding.quantity;
                holding.currentValueArs = currentPriceArs * holding.quantity;
                holding.currentPriceArs = currentPriceArs;
                holding.currentPriceUsd = priceUsd;
                holding.gainArs = holding.currentValueArs - holding.totalCost;
                
                delete holding.totalCost;
            }

            return activeHoldings;
        }

        function appendMessage(sender, text) {
            const messageElement = document.createElement('div');
            messageElement.classList.add('message');
            messageElement.classList.add(`${sender}-message`);
            messageElement.innerText = text;
            chatMessages.appendChild(messageElement);
            chatMessages.scrollTop = chatMessages.scrollHeight;
            return messageElement;
        }

        function base64ToArrayBuffer(base64) {
            const binaryString = atob(base64);
            const len = binaryString.length;
            const bytes = new Uint8Array(len);
            for (let i = 0; i < len; i++) {
                bytes[i] = binaryString.charCodeAt(i);
            }
            return bytes.buffer;
        }

        function pcmToWav(pcm16, sampleRate) {
            const numChannels = 1;
            const bytesPerSample = 2;
            const blockAlign = numChannels * bytesPerSample;
            const byteRate = sampleRate * blockAlign;
            const dataLength = pcm16.length * bytesPerSample;
            const buffer = new ArrayBuffer(44 + dataLength);
            const view = new DataView(buffer);

            view.setUint32(0, 0x52494646, false);
            view.setUint32(4, 36 + dataLength, true);
            view.setUint32(8, 0x57415645, false);
            view.setUint32(12, 0x666d7420, false);
            view.setUint32(16, 16, true);
            view.setUint16(20, 1, true);
            view.setUint16(22, numChannels, true);
            view.setUint32(24, sampleRate, true);
            view.setUint32(28, byteRate, true);
            view.setUint16(32, blockAlign, true);
            view.setUint16(34, 16, true);
            view.setUint32(36, 0x64617461, false);
            view.setUint32(40, dataLength, true);

            let offset = 44;
            for (let i = 0; i < pcm16.length; i++, offset += 2) {
                view.setInt16(offset, pcm16[i], true);
            }

            return new Blob([view], { type: 'audio/wav' });
        }

        async function generateAudioSummary() {
            if (transactions.length === 0) {
                 showCustomAlert('No hay transacciones registradas para generar un resumen.', 'info');
                 return;
            }

            showCustomAlert('Generando resumen por voz... üéôÔ∏è', 'loading');
            
            try {
                await calculateAndDisplaySummary();
                
                const balanceArsText = document.getElementById('balanceArs').innerText;
                const gainArsText = document.getElementById('gainArs').innerText;
                const gainUsdText = document.getElementById('gainUsd').innerText;
                
                let textToSpeak = `Hola, tu resumen de portafolio es el siguiente. El saldo total en pesos es ${balanceArsText}. Tienes una ganancia de ${gainArsText} pesos, y una ganancia de ${gainUsdText} d√≥lares.`;
                
                // Usando un modelo que admite TTS
                const apiKey = ""; 
                const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-tts:generateContent?key=${apiKey}`;
                
                const payload = {
                    contents: [{ parts: [{ text: textToSpeak }] }],
                    generationConfig: {
                        responseModalities: ["AUDIO"],
                        speechConfig: {
                            voiceConfig: {
                                prebuiltVoiceConfig: { voiceName: "Charon" } 
                            }
                        }
                    },
                    model: "gemini-2.5-flash-preview-tts"
                };

                const response = await fetch(apiUrl, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });
                
                if (!response.ok) {
                     throw new Error(`Error en la API de TTS: ${response.status}`);
                }

                const result = await response.json();
                const part = result?.candidates?.[0]?.content?.parts?.[0];
                const audioData = part?.inlineData?.data;
                const mimeType = part?.inlineData?.mimeType;

                if (audioData && mimeType && mimeType.startsWith("audio/")) {
                    const sampleRateMatch = mimeType.match(/rate=(\d+)/);
                    const sampleRate = sampleRateMatch ? parseInt(sampleRateMatch[1], 10) : 16000;
                    
                    const pcmData = base64ToArrayBuffer(audioData);
                    const pcm16 = new Int16Array(pcmData);
                    
                    const wavBlob = pcmToWav(pcm16, sampleRate);
                    const audioUrl = URL.createObjectURL(wavBlob);
                    
                    const audio = new Audio(audioUrl);
                    audio.play();

                    showCustomAlert('Resumen de portafolio en reproducci√≥n', 'success');
                } else {
                    throw new Error("Respuesta de audio inv√°lida o incompleta.");
                }

            } catch (error) {
                console.error("Error al generar resumen de voz:", error);
                showCustomAlert('Error al generar audio. (Si usas un modelo que no es TTS, revisa la documentaci√≥n).', 'alert');
            }
        }

        // --- Exportaci√≥n e Importaci√≥n (Mantenidas) ---

        function exportToExcel() {
             if (transactions.length === 0) {
                showCustomAlert('No hay transacciones para exportar', 'alert');
                return;
            }
            
            showCustomAlert('La funcionalidad de exportar a Excel requiere una librer√≠a externa. Usa la exportaci√≥n a JSON para guardar tus datos de forma segura.', 'info');
        }

        function exportToJSON() {
            const data = {
                portfolios: portfolios,
                transactions: transactions,
                favorites: favorites,
                transactionColumns: transactionColumns, // Guardar el estado de las columnas
                exportDate: new Date().toISOString(),
                version: '1.1'
            };

            const blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' });
            const link = document.createElement('a');
            const url = URL.createObjectURL(blob);
            link.setAttribute('href', url);
            link.setAttribute('download', `GuiarCapital_Backup_${new Date().toISOString().split('T')[0]}.json`);
            link.style.visibility = 'hidden';
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);

            showCustomAlert('Backup JSON exportado exitosamente', 'success');
        }

        function importFromJSON(event) {
            const file = event.target.files[0];
            if (!file) return;

            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const data = JSON.parse(e.target.result);
                    
                    // Reemplazo de window.confirm()
                    if (confirm('¬øImportar datos? Esto reemplazar√° todos los datos actuales.')) {
                        if (data.portfolios) portfolios = data.portfolios;
                        if (data.transactions) transactions = data.transactions;
                        if (data.favorites) favorites = data.favorites || [];
                        if (data.transactionColumns) transactionColumns = data.transactionColumns; // Cargar estado de columnas

                        saveData();
                        displayPortfolios();
                        updatePortfolioSelects();
                        updatePortfolioFilterTransactions();
                        calculateAndDisplaySummary();
                        displayHoldings();
                        displayFavorites();
                        
                        showCustomAlert('Datos importados correctamente', 'success');
                    }
                } catch (error) {
                    showCustomAlert('Error al leer el archivo: ' + error.message, 'alert');
                }
            };
            reader.readAsText(file);
        }

        function saveData() {
            localStorage.setItem('portfolios', JSON.stringify(portfolios));
            localStorage.setItem('transactions', JSON.stringify(transactions));
            localStorage.setItem('favorites', JSON.stringify(favorites));
            // Asegurarse de guardar el estado de las columnas
            localStorage.setItem('transactionColumns', JSON.stringify(transactionColumns)); 
        }

        // Inicializaci√≥n
        function init() {
            loadDollarRates();
            setInterval(loadDollarRates, 5 * 60 * 1000); 
            
            document.getElementById('transactionDate').valueAsDate = new Date();
            
            displayPortfolios();
            displayFavorites();
            
            updateInstallButtonState(); // Llamar para configurar el estado inicial de los botones
            
            if (portfolios.length > 0) {
                calculateAndDisplaySummary();
                displayHoldings();
            } else {
                document.querySelector('.nav-tab').click();
            }
        }

        if ('serviceWorker' in navigator) {
            window.addEventListener('load', () => {
                const swCode = `
                    const CACHE_NAME = 'bolsa-argentina-v1';
                    const urlsToCache = ['/', '/styles.css', '/script.js'];

                    self.addEventListener('install', (event) => {
                        event.waitUntil(
                            caches.open(CACHE_NAME)
                                .then((cache) => cache.addAll(urlsToCache))
                        );
                    });

                    self.addEventListener('fetch', (event) => {
                        event.respondWith(
                            caches.match(event.request)
                                .then((response) => {
                                    if (response) {
                                        return response;
                                    }
                                    return fetch(event.request);
                                }
                            )
                        );
                    });
                `;

                const blob = new Blob([swCode], { type: 'application/javascript' });
                const swUrl = URL.createObjectURL(blob);

                navigator.serviceWorker.register(swUrl)
                    .then((registration) => {
                        console.log('Service Worker registrado exitosamente');
                    })
                    .catch((error) => {
                        console.log('Error al registrar Service Worker:', error);
                    });
            });
        }
        
        document.addEventListener('DOMContentLoaded', init);
        window.addEventListener('beforeunload', saveData);
    </script>
</body>
</html>
