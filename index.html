<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>GuiarCapital</title>
    <link rel="manifest" href="/manifest.json">
    <meta name="theme-color" content="#3b82f6">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #1e293b 0%, #334155 100%);
            color: #e2e8f0;
            min-height: 100vh;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
        }

        .header {
            text-align: center;
            margin-bottom: 30px;
            padding: 20px;
            background: rgba(59, 130, 246, 0.1);
            border-radius: 15px;
            backdrop-filter: blur(10px);
            border: 1px solid rgba(59, 130, 246, 0.2);
            position: relative;
        }

        .header h1 {
            color: #3b82f6;
            margin-bottom: 10px;
            font-size: 2.5em;
            font-weight: 700;
        }
        
        /* Estilos para el nuevo banner */
        .top-banner {
            background: #f59e0b; /* Amber */
            color: #1e293b;
            padding: 15px 20px;
            border-radius: 10px;
            margin-bottom: 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            font-weight: 600;
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.2);
        }

        .btn-dismiss {
            background: transparent;
            border: none;
            color: #1e293b;
            font-size: 1.2em;
            cursor: pointer;
            opacity: 0.8;
            transition: opacity 0.2s;
            padding: 0 10px;
        }

        .btn-dismiss:hover {
            opacity: 1;
        }
        /* Fin estilos banner */

        .portfolio-summary {
            display: flex;
            justify-content: center;
            flex-wrap: wrap;
            gap: 15px;
            margin-top: 20px;
            margin-bottom: 20px;
        }

        .summary-card {
            background: rgba(30, 41, 59, 0.6);
            padding: 15px;
            border-radius: 10px;
            border: 1px solid rgba(71, 85, 105, 0.3);
            text-align: center;
            flex: 1 1 200px;
            min-width: 180px;
        }

        .summary-card .label {
            font-size: 14px;
            color: #94a3b8;
            margin-bottom: 5px;
        }

        .summary-card .value {
            font-size: 1.5em;
            font-weight: 600;
            color: #e2e8f0;
        }
        
        .positive-gain {
            color: #10b981;
        }

        .negative-gain {
            color: #ef4444;
        }

        .dollar-widget {
            margin-top: 20px;
            padding: 15px;
            background: rgba(16, 185, 129, 0.1);
            border: 1px solid rgba(16, 185, 129, 0.2);
            border-radius: 10px;
            position: relative;
        }

        .dollar-widget h3 {
            color: #10b981;
            margin-bottom: 15px;
            font-size: 1.2em;
        }

        .dollar-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 10px;
            margin-bottom: 10px;
        }

        .dollar-card {
            background: rgba(30, 41, 59, 0.6);
            padding: 12px;
            border-radius: 8px;
            border: 1px solid rgba(71, 85, 105, 0.3);
            text-align: center;
        }

        .dollar-card .name {
            font-size: 12px;
            color: #94a3b8;
            font-weight: 500;
            margin-bottom: 4px;
        }

        .dollar-card .buy,
        .dollar-card .sell {
            font-size: 14px;
            font-weight: 600;
            margin: 2px 0;
        }

        .dollar-card .buy {
            color: #10b981;
        }

        .dollar-card .sell {
            color: #f59e0b;
        }

        .btn-refresh {
            position: absolute;
            top: 15px;
            right: 15px;
            background: rgba(16, 185, 129, 0.2);
            border: 1px solid rgba(16, 185, 129, 0.3);
            color: #10b981;
            padding: 5px 8px;
            border-radius: 5px;
            cursor: pointer;
            font-size: 12px;
            transition: all 0.3s ease;
        }

        .btn-refresh:hover {
            background: rgba(16, 185, 129, 0.3);
        }

        .loading {
            text-align: center;
            color: #94a3b8;
            font-style: italic;
            padding: 20px;
        }

        .last-update {
            font-size: 11px;
            color: #64748b;
            text-align: center;
            margin-top: 5px;
        }

        .nav-tabs {
            display: flex;
            gap: 10px;
            margin-bottom: 30px;
            flex-wrap: wrap;
        }

        .nav-tab {
            padding: 12px 24px;
            background: rgba(59, 130, 246, 0.1);
            border: 2px solid rgba(59, 130, 246, 0.3);
            border-radius: 10px;
            color: #e2e8f0;
            cursor: pointer;
            transition: all 0.3s ease;
            font-weight: 500;
        }

        .nav-tab:hover {
            background: rgba(59, 130, 246, 0.2);
            border-color: #3b82f6;
        }

        .nav-tab.active {
            background: #3b82f6;
            border-color: #3b82f6;
            color: white;
        }

        .tab-content {
            display: none;
            background: rgba(30, 41, 59, 0.8);
            border-radius: 15px;
            padding: 30px;
            backdrop-filter: blur(10px);
            border: 1px solid rgba(71, 85, 105, 0.3);
        }

        .tab-content.active {
            display: block;
        }

        .form-group {
            margin-bottom: 20px;
        }

        .form-group label {
            display: block;
            margin-bottom: 8px;
            color: #94a3b8;
            font-weight: 500;
        }

        .form-group input,
        .form-group select,
        .form-group textarea {
            width: 100%;
            padding: 12px;
            border: 2px solid rgba(71, 85, 105, 0.3);
            border-radius: 8px;
            background: rgba(30, 41, 59, 0.7);
            color: #e2e8f0;
            font-size: 16px;
            transition: border-color 0.3s ease;
        }

        .form-group input:focus,
        .form-group select:focus,
        .form-group textarea:focus {
            outline: none;
            border-color: #3b82f6;
        }

        .form-row {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
        }

        .btn {
            padding: 12px 24px;
            background: #3b82f6;
            color: white;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-size: 16px;
            font-weight: 500;
            transition: all 0.3s ease;
            margin-right: 10px;
            margin-bottom: 10px;
        }

        .btn:hover {
            background: #2563eb;
            transform: translateY(-2px);
        }

        .btn-secondary {
            background: #6b7280;
        }

        .btn-secondary:hover {
            background: #4b5563;
        }

        .btn-danger {
            background: #ef4444;
        }

        .btn-danger:hover {
            background: #dc2626;
        }

        .portfolio-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .portfolio-card {
            background: rgba(59, 130, 246, 0.1);
            border: 1px solid rgba(59, 130, 246, 0.2);
            border-radius: 15px;
            padding: 20px;
            backdrop-filter: blur(10px);
        }

        .portfolio-card h3 {
            color: #3b82f6;
            margin-bottom: 10px;
        }

        .stock-search {
            position: relative;
        }

        .stock-suggestions {
            position: absolute;
            top: 100%;
            left: 0;
            right: 0;
            background: rgba(30, 41, 59, 0.95);
            border: 1px solid rgba(71, 85, 105, 0.3);
            border-radius: 8px;
            max-height: 200px;
            overflow-y: auto;
            z-index: 1000;
            display: none;
        }

        .stock-suggestion {
            padding: 10px;
            cursor: pointer;
            border-bottom: 1px solid rgba(71, 85, 105, 0.2);
        }

        .stock-suggestion:hover {
            background: rgba(59, 130, 246, 0.2);
        }

        .stock-suggestion:last-child {
            border-bottom: none;
        }

        .transactions-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 20px;
            background: rgba(30, 41, 59, 0.8);
            border-radius: 10px;
            overflow: hidden;
        }

        .transactions-table th,
        .transactions-table td {
            padding: 10px 8px; /* Ajuste para m√°s columnas */
            text-align: left;
            border-bottom: 1px solid rgba(71, 85, 105, 0.3);
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            font-size: 14px;
        }

        .transactions-table th {
            background: rgba(59, 130, 246, 0.2);
            color: #3b82f6;
            font-weight: 600;
        }

        .install-prompt {
            position: fixed;
            top: 20px;
            right: 20px;
            background: #3b82f6;
            color: white;
            padding: 15px 20px;
            border-radius: 10px;
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.3);
            display: none;
            z-index: 2000;
            animation: slideIn 0.3s ease-out;
        }

        @keyframes slideIn {
            from {
                transform: translateX(100%);
                opacity: 0;
            }
            to {
                transform: translateX(0);
                opacity: 1;
            }
        }

        .install-prompt button {
            margin-left: 10px;
            padding: 5px 10px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
        }

        .scrollable-table {
            overflow-x: auto;
            margin-top: 20px;
        }

        .ai-chat {
            height: 500px;
            display: flex;
            flex-direction: column;
        }

        .chat-messages {
            flex-grow: 1;
            overflow-y: auto;
            padding: 10px;
            background: rgba(30, 41, 59, 0.6);
            border-radius: 10px;
            margin-bottom: 10px;
        }

        .chat-input {
            display: flex;
        }

        .chat-input input {
            flex-grow: 1;
            border-top-right-radius: 0;
            border-bottom-right-radius: 0;
        }

        .chat-input button {
            border-top-left-radius: 0;
            border-bottom-left-radius: 0;
        }

        .message {
            margin-bottom: 10px;
            padding: 8px 12px;
            border-radius: 15px;
            word-wrap: break-word;
        }

        .user-message {
            background: #3b82f6;
            margin-left: auto;
            max-width: 80%;
        }

        .ai-message {
            background: #475569;
            margin-right: auto;
            max-width: 80%;
        }

        @media (max-width: 768px) {
            .container {
                padding: 10px;
            }

            .header h1 {
                font-size: 2em;
            }

            .dollar-grid {
                grid-template-columns: repeat(2, 1fr);
            }

            .dollar-widget {
                padding: 10px;
            }

            .nav-tabs {
                justify-content: center;
            }

            .nav-tab {
                flex: 1;
                text-align: center;
                min-width: 120px;
            }

            .form-row {
                grid-template-columns: 1fr;
            }

            .transactions-table {
                font-size: 10px; /* Reducci√≥n de fuente en m√≥vil */
            }

            .transactions-table th,
            .transactions-table td {
                padding: 6px 3px;
            }
        }
    </style>
</head>
<body>
    <div id="installPrompt" class="install-prompt">
        <span>¬øInstalar la aplicaci√≥n?</span>
        <button onclick="installApp()" style="background: white; color: #3b82f6;">Instalar</button>
        <button onclick="dismissInstall()" style="background: transparent; color: white;">Ahora no</button>
    </div>

    <div class="container">
        <!-- TOP BANNER AGREGADO -->
        <div id="topBanner" class="top-banner" style="display: none;">
            <p>¬°Bienvenido! Los precios en vivo son informativos y utilizan la API de Alpha Vantage (USD) y la cotizaci√≥n MEP para la conversi√≥n a pesos ($).</p>
            <button class="btn-dismiss" onclick="dismissBanner()">‚úñ</button>
        </div>
        <!-- FIN TOP BANNER -->

        <header class="header">
            <h1>üìà GuiarCapital</h1>
            <p>Gestiona tus inversiones y portafolios de manera profesional</p>
            
            <!-- Widget de Cotizaciones del D√≥lar -->
            <div id="dollarRates" class="dollar-widget">
                <h3>üíµ Cotizaciones del D√≥lar</h3>
                <div class="dollar-grid" id="dollarGrid">
                    <div class="loading">Cargando cotizaciones...</div>
                </div>
                <button class="btn-refresh" onclick="loadDollarRates()" title="Actualizar cotizaciones">üîÑ</button>
            </div>

            <!-- Resumen del Portafolio -->
            <div id="portfolioSummary" class="portfolio-summary">
                <div class="summary-card">
                    <div class="label">Saldo Total $</div>
                    <div class="value" id="balanceArs">Cargando...</div>
                </div>
                <div class="summary-card">
                    <div class="label">Ganancia $</div>
                    <div class="value" id="gainArs">Cargando...</div>
                </div>
                <div class="summary-card">
                    <div class="label">Saldo Total USD</div>
                    <div class="value" id="balanceUsd">Cargando...</div>
                </div>
                <div class="summary-card">
                    <div class="label">Ganancia USD</div>
                    <div class="value" id="gainUsd">Cargando...</div>
                </div>
            </div>

        </header>

        <nav class="nav-tabs">
            <div class="nav-tab active" onclick="showTab('portfolios', this)">Portafolios</div>
            <div class="nav-tab" onclick="showTab('transaction', this)">Nueva Transacci√≥n</div>
            <div class="nav-tab" onclick="showTab('transactions', this)">Ver Transacciones</div>
            <div class="nav-tab" onclick="showTab('export', this)">Exportar</div>
            <div class="nav-tab" onclick="showTab('aiAssistant', this)">Asistente AI</div>
        </nav>

        <!-- Tab: Portafolios -->
        <div id="portfolios" class="tab-content active">
            <h2>Gesti√≥n de Portafolios</h2>
            
            <div class="form-group">
                <label>Crear Nuevo Portafolio</label>
                <div class="form-row">
                    <input type="text" id="portfolioName" placeholder="Nombre del portafolio">
                    <input type="text" id="portfolioBroker" placeholder="Broker">
                    <button class="btn" onclick="createPortfolio()">Crear</button>
                </div>
            </div>

            <div id="portfoliosList" class="portfolio-grid">
                <!-- Los portafolios se mostrar√°n aqu√≠ -->
            </div>

            <!-- SECCI√ìN: Posiciones Actuales (con precios en vivo) -->
            <h2 style="color: #3b82f6; margin-top: 30px; margin-bottom: 20px;">Posiciones Actuales y Precios en Vivo</h2>
            
            <div class="scrollable-table">
                <table id="holdingsTable" class="transactions-table">
                    <thead>
                        <tr>
                            <th>Ticker</th>
                            <th>Tipo</th>
                            <th>Cantidad</th>
                            <th>Costo Prom. ($)</th>
                            <!-- Precio de la acci√≥n subyacente en el mercado original (USD) -->
                            <th>Precio Subyacente (USD)</th>
                            <!-- Precio de la unidad de CEDEAR/Acci√≥n en USD -->
                            <th>Precio CEDEAR/Acc. (USD)</th> 
                            <th>Precio CEDEAR/Acc. ($ Impl√≠cito)</th>
                            <th>Valor Actual ($)</th>
                            <th>Ganancia/P√©rdida ($)</th>
                        </tr>
                    </thead>
                    <tbody>
                        <!-- Las tenencias se mostrar√°n aqu√≠ -->
                    </tbody>
                </table>
            </div>
            <!-- FIN SECCI√ìN -->

            <div class="form-group" style="margin-top: 30px;">
                <label>Ver Transacciones de:</label>
                <select id="portfolioFilter" onchange="filterTransactions()">
                    <option value="all">Todas las carteras</option>
                </select>
            </div>
        </div>

        <!-- Tab: Nueva Transacci√≥n -->
        <div id="transaction" class="tab-content">
            <h2>Registrar Nueva Transacci√≥n</h2>
            
            <form onsubmit="addTransaction(event)">
                <div class="form-row">
                    <div class="form-group">
                        <label>Portafolio</label>
                        <select id="transactionPortfolio" required>
                            <option value="">Seleccionar portafolio</option>
                        </select>
                    </div>
                    
                    <div class="form-group stock-search">
                        <label>Ticker/S√≠mbolo</label>
                        <input type="text" id="stockSymbol" placeholder="Ej: GGAL, YPFD, ALUA" required oninput="searchStocks(this.value)" autocomplete="off">
                        <div id="stockSuggestions" class="stock-suggestions"></div>
                    </div>
                </div>

                <div class="form-row">
                    <div class="form-group">
                        <label>Tipo</label>
                        <select id="transactionType" required>
                            <option value="compra">Compra</option>
                            <option value="venta">Venta</option>
                        </select>
                    </div>
                    
                    <div class="form-group">
                        <label>Tipo de Activo</label>
                        <select id="assetType" required>
                            <option value="accion">Acci√≥n</option>
                            <option value="cedear">CEDEAR</option>
                        </select>
                    </div>
                </div>

                <div class="form-row">
                    <div class="form-group">
                        <label>Precio por acci√≥n</label>
                        <input type="number" id="stockPrice" step="0.01" required placeholder="0.00">
                    </div>
                    
                    <div class="form-group">
                        <label>Moneda</label>
                        <select id="currency" required>
                            <option value="ARS">$ (Pesos)</option> 
                            <option value="USD">USD (D√≥lares)</option>
                        </select>
                    </div>
                </div>

                <div class="form-row">
                    <div class="form-group">
                        <label>Cantidad</label>
                        <input type="number" id="quantity" required placeholder="100">
                    </div>
                    
                    <div class="form-group">
                        <label>Fecha</label>
                        <input type="date" id="transactionDate" required>
                    </div>
                </div>

                <div class="form-group">
                    <label>Notas (opcional)</label>
                    <textarea id="notes" rows="3" placeholder="Comentarios adicionales..."></textarea>
                </div>

                <button type="submit" class="btn">Registrar Transacci√≥n</button>
            </form>
        </div>

        <!-- Tab: Ver Transacciones -->
        <div id="transactions" class="tab-content">
            <h2>Historial de Transacciones</h2>
            
            <div class="scrollable-table">
                <table id="transactionsTable" class="transactions-table">
                    <thead>
                        <tr>
                            <th>Fecha</th>
                            <th>Portafolio</th>
                            <th>Ticker</th>
                            <th>Tipo</th>
                            <th>Precio Transacci√≥n</th>
                            <th>Cantidad</th>
                            <!-- Nuevas columnas para precios en vivo y ganancia -->
                            <th>Precio Actual ($ Unidad)</th> 
                            <th>Valor Actual ($ Total)</th>
                            <th>Ganancia/P√©rdida ($)</th>
                            <th>Acciones</th>
                        </tr>
                    </thead>
                    <tbody>
                        <!-- Las transacciones se mostrar√°n aqu√≠ -->
                    </tbody>
                </table>
            </div>
        </div>

        <!-- Tab: Exportar -->
        <div id="export" class="tab-content">
            <h2>Exportar Datos</h2>
            
            <div class="form-group">
                <p>Exporta todas tus transacciones a formato Excel (.xlsx) para an√°lisis externo.</p>
                <button class="btn" onclick="exportToExcel()">üìä Exportar a Excel</button>
                <button class="btn btn-secondary" onclick="exportToJSON()">üìÑ Exportar JSON</button>
            </div>

            <div class="form-group">
                <label>Importar datos desde JSON</label>
                <input type="file" id="importFile" accept=".json" onchange="importFromJSON(event)">
            </div>
        </div>

        <!-- Tab: Asistente AI -->
        <div id="aiAssistant" class="tab-content">
            <h2>Asistente de Inversi√≥n IA</h2>
            <p style="color:#94a3b8; margin-bottom: 20px;">
                Pregunta al asistente sobre tu portafolio o sobre t√©rminos financieros. Por ejemplo: "¬øCu√°l es mi ganancia total?", "¬øQu√© es un CEDEAR?".
            </p>
            <div class="ai-chat">
                <div id="chatMessages" class="chat-messages">
                    <div class="message ai-message">
                        ¬°Hola! Soy tu asistente de inversi√≥n. ¬øEn qu√© puedo ayudarte hoy?
                    </div>
                </div>
                <div class="chat-input">
                    <input type="text" id="aiInput" placeholder="Escribe tu pregunta aqu√≠..." onkeypress="if(event.key === 'Enter') sendAIChat()">
                    <button class="btn" onclick="sendAIChat()">Enviar</button>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Variables globales
        let portfolios = JSON.parse(localStorage.getItem('portfolios') || '[]');
        let transactions = JSON.parse(localStorage.getItem('transactions') || '[]');
        let deferredPrompt;
        let dollarRates = {};
        
        // Almacena los precios de las acciones para evitar m√∫ltiples peticiones
        let stockPricesCache = {}; 
        
        // Alpha Vantage API key proporcionada por el usuario
        const ALPHA_VANTAGE_API_KEY = '1RW4YGC5ZFFQHGA6';
        
        // Lista de CEDEARs con su ratio, extra√≠do del PDF
        const cedearsRatios = {
            'AAPL': 10, 'MELI': 2, 'TSLA': 15, 'GOOGL': 20, 'MSFT': 8, 'AMZN': 72, 
            'BABA': 9, 'NVDA': 24, 'XOM': 6, 'WMT': 12, 'KO': 1, 'MCD': 6, 'MMM': 6,
            'JPM': 6, 'BAC': 6, 'WFC': 30, 'C': 30, 'AXP': 10, 'VISA': 10, 'MA': 2,
            'NFLX': 2, 'INTC': 20, 'CSCO': 10, 'IBM': 2, 'ORCL': 10, 'SAP': 10,
            'PFE': 10, 'MRK': 10, 'JNJ': 5, 'ABBV': 5, 'LLY': 1, 'UNH': 5, 'PG': 5,
            'SBUX': 4, 'BBY': 4, 'T': 20, 'VZ': 20, 'TM': 2, 'KO': 1, 'PEP': 1,
            'NKE': 4, 'ADBE': 12, 'PYPL': 15, 'CRM': 15, 'DISN': 8, 'AMD': 10,
            'EBAY': 12, 'WBA': 10, 'MDLZ': 10, 'BA': 10
        };

        // Datos de acciones argentinas (muestra)
        // Nota: Para estas acciones, la API de Alpha Vantage devuelve null, por lo que usaremos el costo promedio como valor actual
        const argentineStocks = [
            { symbol: 'GGAL', name: 'Grupo Galicia' }, { symbol: 'YPFD', name: 'YPF' },
            { symbol: 'ALUA', name: 'Aluar' }, { symbol: 'BBAR', name: 'Banco BBVA' },
            { symbol: 'BMA', name: 'Banco Macro' }, { symbol: 'BYMA', name: 'Bolsas y Mercados' },
            { symbol: 'CEPU', name: 'Central Puerto' }, { symbol: 'CRES', name: 'Cresud' },
            { symbol: 'EDN', name: 'Edenor' }, { symbol: 'FRAN', name: 'Fran' },
            { symbol: 'SUPV', name: 'Grupo Supervielle' }, { symbol: 'TECO2', name: 'Telecom' },
        ];
        
        // Combina las acciones argentinas y los CEDEARs para las sugerencias
        const allAvailableSymbols = [
            ...argentineStocks.map(s => ({ symbol: s.symbol, name: s.name })),
            ...Object.keys(cedearsRatios).map(symbol => ({ symbol: symbol, name: symbol }))
        ];

        // Funci√≥n para descartar el banner
        function dismissBanner() {
            document.getElementById('topBanner').style.display = 'none';
            localStorage.setItem('bannerDismissed', 'true');
        }

        // Funci√≥n para cargar cotizaciones del d√≥lar
        async function loadDollarRates() {
            const dollarGrid = document.getElementById('dollarGrid');
            dollarGrid.innerHTML = '<div class="loading">Actualizando cotizaciones...</div>';
            
            try {
                const endpoints = [
                    { name: 'Oficial', url: 'https://dolarapi.com/v1/dolares/oficial' },
                    { name: 'Blue', url: 'https://dolarapi.com/v1/dolares/blue' },
                    { name: 'MEP', url: 'https://dolarapi.com/v1/dolares/bolsa' },
                    { name: 'CCL', url: 'https://dolarapi.com/v1/dolares/contadoconliqui' }
                ];
                
                const promises = endpoints.map(async endpoint => {
                    try {
                        const response = await fetch(endpoint.url);
                        if (!response.ok) throw new Error('Error en la respuesta');
                        const data = await response.json();
                        return { name: endpoint.name, data };
                    } catch (error) {
                        console.error(`Error cargando ${endpoint.name}:`, error);
                        return { name: endpoint.name, data: null };
                    }
                });
                
                const results = await Promise.all(promises);
                
                let gridHTML = '';
                let validRates = 0;
                
                results.forEach(result => {
                    if (result.data) {
                        validRates++;
                        dollarRates[result.name.toLowerCase()] = result.data;
                        // Uso de $ para pesos
                        gridHTML += `
                            <div class="dollar-card">
                                <div class="name">${result.name}</div>
                                <div class="buy">C: $${result.data.compra ? result.data.compra.toFixed(2) : 'N/D'}</div>
                                <div class="sell">V: $${result.data.venta ? result.data.venta.toFixed(2) : 'N/D'}</div>
                            </div>
                        `;
                    }
                });
                
                if (validRates === 0) {
                    gridHTML = '<div class="loading">‚ö†Ô∏è Error al cargar cotizaciones</div>';
                } else {
                    const lastUpdate = new Date().toLocaleString('es-AR');
                    gridHTML += `<div class="last-update">Actualizado: ${lastUpdate}</div>`;
                }
                
                dollarGrid.innerHTML = gridHTML;
                
                // Despu√©s de cargar las cotizaciones, actualizar el resumen del portafolio y las tenencias
                calculateAndDisplaySummary();
                displayHoldings();
            } catch (error) {
                console.error('Error general cargando cotizaciones:', error);
                dollarGrid.innerHTML = '<div class="loading">‚ö†Ô∏è Sin conexi√≥n a internet</div>';
            }
        }
        
        // Funci√≥n para convertir monedas usando las cotizaciones
        function convertCurrency(amount, fromCurrency, toCurrency, rateType = 'oficial') {
            if (fromCurrency === toCurrency) return amount;
            
            const rate = dollarRates[rateType];
            // Si la tasa no est√° cargada, retornar el mismo monto
            if (!rate) return amount; 
            
            if (fromCurrency === 'USD' && toCurrency === 'ARS') {
                // Usamos la tasa de VENTA para saber cu√°nto ARS obtenemos por 1 USD
                return amount * (rate.venta || rate.compra || 1);
            } else if (fromCurrency === 'ARS' && toCurrency === 'USD') {
                // Usamos la tasa de COMPRA para saber cu√°nto USD obtenemos por 1 ARS
                return amount / (rate.compra || rate.venta || 1);
            }
            
            return amount;
        }

        // --- Funciones para la integraci√≥n con Alpha Vantage ---

        // Funci√≥n para obtener precio de una acci√≥n con reintento y backoff exponencial
        async function fetchStockPriceWithRetry(symbol, retries = 3, delay = 1000) {
            // Verifica si el ticker es una acci√≥n argentina (no CEDEAR)
            const isArgentineStock = argentineStocks.some(s => s.symbol === symbol);
            
            // Si es acci√≥n argentina, no intentamos obtener el precio de AV (ya que no lo tiene)
            // En un app real, aqu√≠ se usar√≠a una API local.
            if (isArgentineStock) {
                 return null;
            }

            if (stockPricesCache[symbol]) {
                return stockPricesCache[symbol];
            }
            
            // Alpha Vantage devuelve el precio de la acci√≥n subyacente en USD
            const apiUrl = `https://www.alphavantage.co/query?function=GLOBAL_QUOTE&symbol=${symbol}&apikey=${ALPHA_VANTAGE_API_KEY}`;
            
            for (let i = 0; i < retries; i++) {
                try {
                    const response = await fetch(apiUrl);
                    if (!response.ok) {
                        throw new Error(`Alpha Vantage API error: ${response.status}`);
                    }
                    const data = await response.json();
                    
                    if (data['Global Quote'] && data['Global Quote']['05. price']) {
                        const price = parseFloat(data['Global Quote']['05. price']);
                        stockPricesCache[symbol] = price;
                        return price;
                    } else if (data['Note']) {
                        // API rate limit, need to wait
                        console.warn(`Alpha Vantage rate limit reached. Retrying for ${symbol}...`);
                        await new Promise(resolve => setTimeout(resolve, delay * Math.pow(2, i)));
                    } else {
                        // Ticker no encontrado o error en los datos
                        return null; 
                    }
                } catch (error) {
                    console.error(`Error al obtener precio de ${symbol} (intento ${i + 1}):`, error.message);
                    if (i < retries - 1) {
                        await new Promise(resolve => setTimeout(resolve, delay * Math.pow(2, i)));
                    }
                }
            }
            return null; // Retorna null si todos los reintentos fallan
        }

        // Funci√≥n principal para calcular y mostrar el resumen del portafolio
        async function calculateAndDisplaySummary() {
            const balanceArsElement = document.getElementById('balanceArs');
            const gainArsElement = document.getElementById('gainArs');
            const balanceUsdElement = document.getElementById('balanceUsd');
            const gainUsdElement = document.getElementById('gainUsd');
            
            // Mostrar estado de carga mientras se obtienen los datos
            balanceArsElement.innerText = 'Cargando...';
            gainArsElement.innerText = 'Cargando...';
            balanceUsdElement.innerText = 'Cargando...';
            gainUsdElement.innerText = 'Cargando...';

            let totalBalanceArs = 0;
            let totalCostArs = 0;
            let totalBalanceUsd = 0;
            let totalCostUsd = 0;

            const holdings = {}; // { symbol: { quantity: N, assetType: 'accion'|'cedear', costArs: X, costUsd: Y } }

            // 1. Calcular tenencias y costo promedio (lo que ya pagamos)
            transactions.forEach(t => {
                const isBuy = t.type === 'compra';
                const sign = isBuy ? 1 : -1;

                if (!holdings[t.symbol]) {
                    holdings[t.symbol] = { 
                        quantity: 0, 
                        assetType: t.assetType, 
                        costArs: 0, 
                        costUsd: 0,
                    };
                }
                
                // Conversi√≥n a ARS ($) y USD (U$D) del COSTO
                // Usamos d√≥lar MEP para valuaci√≥n general del costo
                const totalInArs = t.currency === 'ARS' ? t.total : convertCurrency(t.total, 'USD', 'ARS', 'mep');
                const totalInUsd = t.currency === 'USD' ? t.total : convertCurrency(t.total, 'ARS', 'USD', 'mep');
                
                holdings[t.symbol].quantity += sign * t.quantity;
                holdings[t.symbol].costArs += sign * totalInArs;
                holdings[t.symbol].costUsd += sign * totalInUsd;
            });

            // 2. Obtener precios de mercado (live) y calcular valor actual
            const symbolsToFetch = [...new Set(Object.keys(holdings))];
            
            // Crear promesas para obtener los precios en paralelo
            const fetchPromises = symbolsToFetch.map(symbol => {
                const holding = holdings[symbol];
                if (holding.quantity <= 0) return Promise.resolve(null);

                return fetchStockPriceWithRetry(symbol)
                    .then(price => {
                        const mepRate = dollarRates.mep ? (dollarRates.mep.venta || dollarRates.mep.compra || 1) : 1;
                        let currentValueArs = 0;
                        let currentValueUsd = 0;
                        
                        if (price !== null) {
                            // Precio de la acci√≥n subyacente en USD
                            const priceSubyacenteUsd = price;

                            if (holding.assetType === 'cedear') {
                                // C√°lculo del precio impl√≠cito del CEDEAR
                                const ratio = cedearsRatios[symbol] || 1;
                                const priceCedearUsd = priceSubyacenteUsd / ratio;
                                currentValueUsd = priceCedearUsd * holding.quantity;
                                currentValueArs = currentValueUsd * mepRate; // Valorizar a ARS con MEP
                            } else {
                                // Acci√≥n local: simulamos valorizar a precio de subyacente * MEP
                                currentValueArs = (priceSubyacenteUsd * mepRate) * holding.quantity;
                                currentValueUsd = currentValueArs / mepRate;
                            }
                        } else {
                            // Si no hay precio en vivo (ej: acciones locales o error), valoramos al costo promedio
                            currentValueArs = holding.costArs;
                            currentValueUsd = holding.costUsd;
                        }
                        
                        totalBalanceArs += currentValueArs;
                        totalBalanceUsd += currentValueUsd;
                        
                        return price;
                    })
                    .catch(() => {
                        // En caso de error de red, valoramos al costo promedio
                        if (holding.quantity > 0) {
                            totalBalanceArs += holding.costArs;
                            totalBalanceUsd += holding.costUsd;
                        }
                    });
            });

            // Esperar que todos los precios sean obtenidos y procesados
            await Promise.all(fetchPromises);
            
            // Recalcular costos totales (necesario si las promesas fallan, aunque el c√°lculo ya est√° en el loop)
            // Esto es redundante pero asegura que el costo se sume correctamente si la promesa falla.
            Object.values(holdings).forEach(holding => {
                if (holding.quantity <= 0) {
                    totalCostArs += holding.costArs;
                    totalCostUsd += holding.costUsd;
                }
            });


            const totalGainArs = totalBalanceArs - totalCostArs;
            const totalGainUsd = totalBalanceUsd - totalCostUsd;
            
            // 3. Mostrar los resultados en la interfaz
            // Uso de $ para ARS
            balanceArsElement.innerText = `$${totalBalanceArs.toFixed(2)}`;
            gainArsElement.innerText = `$${totalGainArs.toFixed(2)}`;
            gainArsElement.classList.toggle('positive-gain', totalGainArs >= 0);
            gainArsElement.classList.toggle('negative-gain', totalGainArs < 0);

            // Uso de U$D para USD
            balanceUsdElement.innerText = `U$D${totalBalanceUsd.toFixed(2)}`;
            gainUsdElement.innerText = `U$D${totalGainUsd.toFixed(2)}`;
            gainUsdElement.classList.toggle('positive-gain', totalGainUsd >= 0);
            gainUsdElement.classList.toggle('negative-gain', totalGainUsd < 0);
        }

        // Nueva funci√≥n para mostrar las tenencias actuales y precios en vivo
        async function displayHoldings() {
            const tbody = document.querySelector('#holdingsTable tbody');
            tbody.innerHTML = '<tr><td colspan="9" style="text-align: center;">Cargando tenencias y precios en vivo...</td></tr>';
            
            // 1. Agrupar tenencias (similar a calculateAndDisplaySummary, pero solo para tenencias > 0)
            const holdings = {};
            transactions.forEach(t => {
                const isBuy = t.type === 'compra';
                const sign = isBuy ? 1 : -1;

                if (!holdings[t.symbol]) {
                    holdings[t.symbol] = { quantity: 0, assetType: t.assetType, costArs: 0, costUsd: 0 };
                }

                const totalInArs = t.currency === 'ARS' ? t.total : convertCurrency(t.total, 'USD', 'ARS', 'mep'); 
                
                holdings[t.symbol].quantity += sign * t.quantity;
                holdings[t.symbol].costArs += sign * totalInArs;
            });

            const activeHoldings = Object.entries(holdings).filter(([, h]) => h.quantity > 0);
            
            if (activeHoldings.length === 0) {
                tbody.innerHTML = '<tr><td colspan="9" style="text-align: center;">No tienes posiciones abiertas.</td></tr>';
                return;
            }

            // 2. Obtener precios de mercado
            const fetchPromises = activeHoldings.map(([symbol, holding]) => 
                fetchStockPriceWithRetry(symbol)
                    .then(price => ({ symbol, price, holding }))
                    .catch(() => ({ symbol, price: null, holding }))
            );

            const results = await Promise.all(fetchPromises);
            
            let rowsHTML = '';
            const mepRate = dollarRates.mep ? (dollarRates.mep.venta || dollarRates.mep.compra || 1) : 1;

            results.forEach(({ symbol, price: stockPriceUsd, holding }) => {
                if (holding.quantity <= 0) return;
                
                const ratio = cedearsRatios[symbol] || 1;
                const assetType = holding.assetType.toUpperCase();
                
                let priceSubyacenteUsdDisplay = 'N/D';
                let priceUnitUsdDisplay = 'N/D'; // Nueva variable para el precio de la unidad en USD
                let pricePerUnitArs = null; 
                let currentValueArs = 0;
                let avgCostArs = holding.costArs / holding.quantity;
                
                if (stockPriceUsd !== null) {
                    // Precio de la acci√≥n subyacente en USD
                    const priceSubyacenteUsd = stockPriceUsd; 
                    priceSubyacenteUsdDisplay = priceSubyacenteUsd.toFixed(2);

                    // Calculamos el precio de la unidad (CEDEAR o Acci√≥n Local) en USD
                    const priceUnitUsd = (assetType === 'CEDEAR') ? (priceSubyacenteUsd / ratio) : priceSubyacenteUsd;
                    priceUnitUsdDisplay = priceUnitUsd.toFixed(2);

                    // Precio Impl√≠cito en Pesos ($)
                    pricePerUnitArs = priceUnitUsd * mepRate;
                    currentValueArs = pricePerUnitArs * holding.quantity;

                } else {
                    // Si no hay precio en vivo (ej: acciones locales o error), usamos el costo promedio
                    pricePerUnitArs = avgCostArs;
                    currentValueArs = holding.costArs;
                }
                
                const gainArs = currentValueArs - holding.costArs;
                const gainClass = gainArs >= 0 ? 'positive-gain' : 'negative-gain';
                
                const pricePerUnitArsDisplay = pricePerUnitArs !== null ? pricePerUnitArs.toFixed(2) : 'N/D';

                rowsHTML += `
                    <tr>
                        <td><strong>${symbol}</strong></td>
                        <td>${assetType}</td>
                        <td>${holding.quantity}</td>
                        <td>$${avgCostArs.toFixed(2)}</td>
                        <td>U$D${priceSubyacenteUsdDisplay}</td>
                        <td>U$D${priceUnitUsdDisplay}</td>
                        <td>$${pricePerUnitArsDisplay}</td>
                        <td>$${currentValueArs.toFixed(2)}</td>
                        <td class="${gainClass}">$${gainArs.toFixed(2)}</td>
                    </tr>
                `;
            });

            tbody.innerHTML = rowsHTML;
        }

        // PWA - Service Worker y instalaci√≥n
        window.addEventListener('beforeinstallprompt', (e) => {
            e.preventDefault();
            deferredPrompt = e;
            document.getElementById('installPrompt').style.display = 'block';
        });

        function installApp() {
            if (deferredPrompt) {
                deferredPrompt.prompt();
                deferredPrompt.userChoice.then((choiceResult) => {
                    if (choiceResult.outcome === 'accepted') {
                        console.log('Usuario instal√≥ la app');
                    }
                    deferredPrompt = null;
                    document.getElementById('installPrompt').style.display = 'none';
                });
            }
        }

        function dismissInstall() {
            document.getElementById('installPrompt').style.display = 'none';
        }

        // Navegaci√≥n entre tabs
        function showTab(tabName, element) {
            document.querySelectorAll('.tab-content').forEach(tab => tab.classList.remove('active'));
            document.querySelectorAll('.nav-tab').forEach(tab => tab.classList.remove('active'));
            
            document.getElementById(tabName).classList.add('active');
            if (element) {
                element.classList.add('active');
            }

            if (tabName === 'portfolios') {
                displayPortfolios();
                calculateAndDisplaySummary();
                displayHoldings(); // Actualizar tenencias
            } else if (tabName === 'transaction') {
                updatePortfolioSelects();
            } else if (tabName === 'transactions') {
                displayTransactions(); // ACTUALIZADO para usar async/await
            }
        }

        // Gesti√≥n de portafolios
        function createPortfolio() {
            const name = document.getElementById('portfolioName').value.trim();
            const broker = document.getElementById('portfolioBroker').value.trim();
            
            if (!name || !broker) {
                showCustomAlert('Por favor completa todos los campos');
                return;
            }

            const portfolio = {
                id: Date.now(),
                name: name,
                broker: broker,
                createdAt: new Date().toISOString()
            };

            portfolios.push(portfolio);
            saveData();
            displayPortfolios();
            updatePortfolioSelects();
            calculateAndDisplaySummary();
            displayHoldings(); // Actualizar tenencias
            
            document.getElementById('portfolioName').value = '';
            document.getElementById('portfolioBroker').value = '';
            
            showCustomAlert('Portafolio creado exitosamente');
        }

        function displayPortfolios() {
            const container = document.getElementById('portfoliosList');
            
            if (portfolios.length === 0) {
                container.innerHTML = '<p>No hay portafolios creados. Crea tu primer portafolio para comenzar.</p>';
                return;
            }

            container.innerHTML = portfolios.map(portfolio => {
                const portfolioTransactions = transactions.filter(t => t.portfolioId === portfolio.id);
                const totalTransactions = portfolioTransactions.length;
                
                return `
                    <div class="portfolio-card">
                        <h3>${portfolio.name}</h3>
                        <p><strong>Broker:</strong> ${portfolio.broker}</p>
                        <p><strong>Transacciones:</strong> ${totalTransactions}</p>
                        <p><strong>Creado:</strong> ${new Date(portfolio.createdAt).toLocaleDateString()}</p>
                        <button class="btn btn-danger" onclick="deletePortfolio(${portfolio.id})">Eliminar</button>
                    </div>
                `;
            }).join('');

            updatePortfolioFilter();
        }

        function deletePortfolio(id) {
            if (confirm('¬øEst√°s seguro de eliminar este portafolio? Se eliminar√°n tambi√©n todas sus transacciones.')) {
                portfolios = portfolios.filter(p => p.id !== id);
                transactions = transactions.filter(t => t.portfolioId !== id);
                saveData();
                displayPortfolios();
                updatePortfolioSelects();
                calculateAndDisplaySummary();
                displayHoldings(); // Actualizar tenencias
            }
        }

        function updatePortfolioSelects() {
            const selects = ['transactionPortfolio'];
            
            selects.forEach(selectId => {
                const select = document.getElementById(selectId);
                select.innerHTML = '<option value="">Seleccionar portafolio</option>';
                
                portfolios.forEach(portfolio => {
                    select.innerHTML += `<option value="${portfolio.id}">${portfolio.name} (${portfolio.broker})</option>`;
                });
            });
        }

        function updatePortfolioFilter() {
            const select = document.getElementById('portfolioFilter');
            select.innerHTML = '<option value="all">Todas las carteras</option>';
            
            portfolios.forEach(portfolio => {
                select.innerHTML += `<option value="${portfolio.id}">${portfolio.name} (${portfolio.broker})</option>`;
            });
        }

        function filterTransactions() {
            const filterValue = document.getElementById('portfolioFilter').value;
            displayTransactions(filterValue === 'all' ? null : parseInt(filterValue));
        }

        // B√∫squeda de acciones
        function searchStocks(query) {
            const suggestions = document.getElementById('stockSuggestions');
            
            if (!query || query.length < 1) {
                suggestions.style.display = 'none';
                return;
            }

            const matches = allAvailableSymbols.filter(stock => 
                stock.symbol.toLowerCase().startsWith(query.toLowerCase()) ||
                (stock.name && stock.name.toLowerCase().includes(query.toLowerCase()))
            );

            if (matches.length === 0) {
                suggestions.style.display = 'none';
                return;
            }

            suggestions.innerHTML = matches.map(stock => 
                `<div class="stock-suggestion" onclick="selectStock('${stock.symbol}')">
                    <strong>${stock.symbol}</strong> - ${stock.name}
                </div>`
            ).join('');
            
            suggestions.style.display = 'block';
        }

        function selectStock(symbol) {
            document.getElementById('stockSymbol').value = symbol;
            document.getElementById('stockSuggestions').style.display = 'none';
            // Pre-seleccionar el tipo de activo si es un CEDEAR
            if (cedearsRatios[symbol]) {
                document.getElementById('assetType').value = 'cedear';
            } else {
                document.getElementById('assetType').value = 'accion';
            }
        }

        // Cerrar sugerencias al hacer clic fuera
        document.addEventListener('click', (e) => {
            if (!e.target.closest('.stock-search')) {
                document.getElementById('stockSuggestions').style.display = 'none';
            }
        });

        // Gesti√≥n de transacciones
        function addTransaction(event) {
            event.preventDefault();
            
            const portfolioId = parseInt(document.getElementById('transactionPortfolio').value);
            const symbol = document.getElementById('stockSymbol').value.trim().toUpperCase();
            const type = document.getElementById('transactionType').value;
            const assetType = document.getElementById('assetType').value;
            const price = parseFloat(document.getElementById('stockPrice').value);
            const currency = document.getElementById('currency').value;
            const quantity = parseInt(document.getElementById('quantity').value);
            const date = document.getElementById('transactionDate').value;
            const notes = document.getElementById('notes').value.trim();

            if (!portfolioId || !symbol || isNaN(price) || isNaN(quantity) || !date || price <= 0 || quantity <= 0) {
                showCustomAlert('Por favor completa todos los campos obligatorios correctamente.');
                return;
            }

            const portfolio = portfolios.find(p => p.id === portfolioId);
            const total = price * quantity;

            const transaction = {
                id: Date.now(),
                portfolioId: portfolioId,
                portfolioName: portfolio.name,
                broker: portfolio.broker,
                symbol: symbol,
                type: type,
                assetType: assetType,
                price: price,
                currency: currency,
                quantity: quantity,
                total: total,
                date: date,
                notes: notes,
                createdAt: new Date().toISOString()
            };

            transactions.push(transaction);
            saveData();
            
            showCustomAlert('Transacci√≥n registrada exitosamente');
            document.querySelector('#transaction form').reset();
            document.getElementById('transactionDate').valueAsDate = new Date();
            
            calculateAndDisplaySummary();
            displayHoldings(); // Actualizar tenencias
        }

        // Funci√≥n displayTransactions ACTUALIZADA
        async function displayTransactions(portfolioFilter = null) {
            const tbody = document.querySelector('#transactionsTable tbody');
            // 1. Mostrar estado de carga (colspan ajustado a 10)
            tbody.innerHTML = '<tr><td colspan="10" style="text-align: center;">Cargando transacciones...</td></tr>';

            let filteredTransactions = transactions;

            if (portfolioFilter) {
                filteredTransactions = transactions.filter(t => t.portfolioId === portfolioFilter);
            }

            if (filteredTransactions.length === 0) {
                tbody.innerHTML = '<tr><td colspan="10" style="text-align: center;">No hay transacciones registradas</td></tr>';
                return;
            }
            
            // 2. Obtener precios en vivo de los s√≠mbolos involucrados
            const uniqueSymbols = [...new Set(filteredTransactions.map(t => t.symbol))];
            const pricesPromises = uniqueSymbols.map(symbol => fetchStockPriceWithRetry(symbol));
            const livePrices = (await Promise.all(pricesPromises)).reduce((acc, price, index) => {
                acc[uniqueSymbols[index]] = price;
                return acc;
            }, {});
            
            const mepRate = dollarRates.mep ? (dollarRates.mep.venta || dollarRates.mep.compra || 1) : 1;
            
            // Helper para mostrar la moneda: ARS -> $
            const getCurrencySymbol = (currency) => currency === 'ARS' ? '$' : 'U$D';

            tbody.innerHTML = filteredTransactions
                .sort((a, b) => new Date(b.date) - new Date(a.date))
                .map(transaction => {
                    const stockPriceUsd = livePrices[transaction.symbol];
                    const ratio = cedearsRatios[transaction.symbol] || 1;
                    const assetType = transaction.assetType.toUpperCase();
                    
                    let priceUnitArsLive = 0;
                    let valueTotalArsLive = 0;
                    let priceTransactSymbol = getCurrencySymbol(transaction.currency);
                    let displayGain = 'N/A';
                    let gainClass = '';

                    // C√°lculo del valor actual
                    if (stockPriceUsd !== null) {
                        // 1. Calcular precio unitario en USD
                        const priceUnitUsd = (assetType === 'CEDEAR') ? (stockPriceUsd / ratio) : stockPriceUsd;

                        // 2. Convertir a ARS ($) usando MEP
                        priceUnitArsLive = priceUnitUsd * mepRate;
                        
                        // 3. Calcular valor total actual en ARS
                        valueTotalArsLive = priceUnitArsLive * transaction.quantity;
                    } else {
                        // Si no hay precio en vivo (acciones locales o error), usar valor hist√≥rico en ARS
                        if (transaction.currency === 'ARS') {
                            priceUnitArsLive = transaction.price;
                            valueTotalArsLive = transaction.total;
                        } else {
                            // USD a ARS usando MEP para estimar el valor actual en pesos
                            priceUnitArsLive = convertCurrency(transaction.price, 'USD', 'ARS', 'mep');
                            valueTotalArsLive = convertCurrency(transaction.total, 'USD', 'ARS', 'mep');
                        }
                    }
                    
                    // Calcular ganancia/p√©rdida (solo para COMPRAS)
                    if (transaction.type === 'compra') {
                        // Convertir el costo hist√≥rico a ARS con la tasa MEP (para base de comparaci√≥n)
                        const costTransactArs = transaction.currency === 'ARS' ? transaction.total : convertCurrency(transaction.total, 'USD', 'ARS', 'mep');
                        
                        const gainArs = valueTotalArsLive - costTransactArs;
                        gainClass = gainArs >= 0 ? 'positive-gain' : 'negative-gain';
                        displayGain = `$${gainArs.toFixed(2)}`;
                    }

                    return `
                        <tr>
                            <td>${new Date(transaction.date).toLocaleDateString()}</td>
                            <td>${transaction.portfolioName}</td>
                            <td><strong>${transaction.symbol}</strong></td>
                            <td><span style="color: ${transaction.type === 'compra' ? '#10b981' : '#ef4444'}">${transaction.type.toUpperCase()}</span></td>
                            <td>${transaction.price.toFixed(2)} ${priceTransactSymbol}</td>
                            <td>${transaction.quantity}</td>
                            <td>$${priceUnitArsLive.toFixed(2)}</td>
                            <td>$${valueTotalArsLive.toFixed(2)}</td>
                            <td class="${gainClass}">${displayGain}</td>
                            <td><button class="btn btn-danger" onclick="deleteTransaction(${transaction.id})" style="padding: 5px 10px; font-size: 12px;">Eliminar</button></td>
                        </tr>
                    `;
                }).join('');
        }

        function deleteTransaction(id) {
            if (confirm('¬øEst√°s seguro de eliminar esta transacci√≥n?')) {
                transactions = transactions.filter(t => t.id !== id);
                saveData();
                displayTransactions();
                displayPortfolios();
                calculateAndDisplaySummary();
                displayHoldings(); // Actualizar tenencias
            }
        }

        // --- Funciones para el Asistente AI ---

        const chatHistory = [];
        let isAILoading = false;
        const chatMessages = document.getElementById('chatMessages');
        
        async function sendAIChat() {
            const aiInput = document.getElementById('aiInput');
            const userMessage = aiInput.value.trim();
            if (!userMessage || isAILoading) return;
            
            isAILoading = true;
            aiInput.value = '';
            
            appendMessage('user', userMessage);
            const loadingMessage = appendMessage('ai', 'Pensando...');
            
            try {
                // Prepara el contexto para la IA
                const portfolioSummary = await getPortfolioSummaryForAI();
                const prompt = `Act√∫a como un asistente financiero experto. Aqu√≠ est√°n los datos del portafolio del usuario: ${JSON.stringify(portfolioSummary)}. El usuario pregunta: "${userMessage}". Responde de manera concisa y √∫til. Evita frases como "Basado en tu portafolio..." y ve directo al punto.`;
                
                // Usando un modelo que no requiere API key para el chat para que funcione en el entorno
                const aiResponse = await getAIResponse(prompt); 
                loadingMessage.innerText = aiResponse;
            } catch (error) {
                console.error("Error al obtener respuesta de la IA:", error);
                loadingMessage.innerText = 'Disculpa, hubo un error al conectar con el asistente. Intenta de nuevo m√°s tarde.';
            } finally {
                isAILoading = false;
            }
        }

        async function getAIResponse(prompt, retries = 3, delay = 1000) {
            const apiKey = "";
            const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${apiKey}`;
            const payload = {
                contents: [{ role: "user", parts: [{ text: prompt }] }],
                tools: [{ "google_search": {} }],
            };
            
            for (let i = 0; i < retries; i++) {
                try {
                    const response = await fetch(apiUrl, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(payload)
                    });
                    
                    if (!response.ok) {
                        const errorData = await response.json();
                        console.error("Error en la API de Gemini:", errorData);
                        throw new Error(`Error de la API: ${response.status}`);
                    }
                    
                    const result = await response.json();
                    
                    if (result.candidates && result.candidates.length > 0 && result.candidates[0].content) {
                        return result.candidates[0].content.parts[0].text;
                    } else {
                        throw new Error('Respuesta de la API de Gemini con formato inesperado.');
                    }
                } catch (error) {
                    if (i < retries - 1) {
                        console.warn(`Error al llamar a Gemini (intento ${i + 1}). Reintentando...`, error);
                        await new Promise(resolve => setTimeout(resolve, delay * Math.pow(2, i)));
                    } else {
                        throw error;
                    }
                }
            }
        }
        
        async function getPortfolioSummaryForAI() {
            // Recalcular el resumen antes de enviarlo a la IA
            const holdingSummary = {};
            
            const uniqueSymbols = [...new Set(transactions.map(t => t.symbol))];
            
            // Obtener precios en vivo
            const pricesPromises = uniqueSymbols.map(symbol => 
                fetchStockPriceWithRetry(symbol).then(price => ({ symbol, price }))
            );
            const prices = await Promise.all(pricesPromises);
            const livePrices = prices.reduce((acc, curr) => {
                acc[curr.symbol] = curr.price;
                return acc;
            }, {});

            transactions.forEach(t => {
                const isBuy = t.type === 'compra';
                const sign = isBuy ? 1 : -1;

                if (!holdingSummary[t.symbol]) {
                    holdingSummary[t.symbol] = {
                        symbol: t.symbol,
                        assetType: t.assetType,
                        currency: t.currency,
                        quantity: 0,
                        totalCost: 0, // En ARS
                    };
                }
                
                // Convertir todo a ARS para el contexto de la IA
                const totalInArs = t.currency === 'ARS' ? t.total : convertCurrency(t.total, 'USD', 'ARS', 'mep');
                
                holdingSummary[t.symbol].quantity += sign * t.quantity;
                holdingSummary[t.symbol].totalCost += sign * totalInArs;
            });
            
            // Filtrar tenencias con cantidad > 0
            const activeHoldings = Object.values(holdingSummary).filter(h => h.quantity > 0);

            // A√±adir precios y valor actual a las tenencias
            for (const holding of activeHoldings) {
                const priceUsd = livePrices[holding.symbol] || 0;
                const mepRate = dollarRates.mep ? (dollarRates.mep.venta || dollarRates.mep.compra || 1) : 1;
                
                let currentPriceArs = 0;
                
                if (holding.assetType === 'cedear') {
                    const ratio = cedearsRatios[holding.symbol] || 1;
                    // Precio en ARS del CEDEAR = (Precio subyacente USD / Ratio) * Tasa MEP
                    currentPriceArs = (priceUsd / ratio) * mepRate;
                } else {
                    // Acci√≥n local: Precio ARS = Precio subyacente USD * Tasa MEP (simulado)
                    currentPriceArs = priceUsd * mepRate;
                }
                
                holding.avgCostArs = holding.totalCost / holding.quantity;
                holding.currentValueArs = currentPriceArs * holding.quantity;
                holding.currentPriceArs = currentPriceArs;
                holding.currentPriceUsd = priceUsd;
                holding.gainArs = holding.currentValueArs - holding.totalCost;
                
                delete holding.totalCost; // Limpiar para un resumen m√°s limpio
            }

            return activeHoldings;
        }

        function appendMessage(sender, text) {
            const messageElement = document.createElement('div');
            messageElement.classList.add('message');
            messageElement.classList.add(`${sender}-message`);
            messageElement.innerText = text;
            chatMessages.appendChild(messageElement);
            chatMessages.scrollTop = chatMessages.scrollHeight;
            return messageElement;
        }

        // Exportaci√≥n e importaci√≥n
        function exportToExcel() {
            if (transactions.length === 0) {
                showCustomAlert('No hay transacciones para exportar');
                return;
            }
            
            // Reemplazar alert con confirm para la interfaz de usuario
            showCustomAlert('La funcionalidad de exportar a Excel est√° siendo revisada para ofrecer una mejor experiencia. Por ahora, usa la exportaci√≥n a JSON para guardar tus datos.', 'info');
        }

        function exportToJSON() {
            const data = {
                portfolios: portfolios,
                transactions: transactions,
                exportDate: new Date().toISOString(),
                version: '1.0'
            };

            const blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' });
            const link = document.createElement('a');
            const url = URL.createObjectURL(blob);
            link.setAttribute('href', url);
            link.setAttribute('download', `backup_bolsa_${new Date().toISOString().split('T')[0]}.json`);
            link.style.visibility = 'hidden';
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);

            showCustomAlert('Backup JSON exportado exitosamente');
        }

        function importFromJSON(event) {
            const file = event.target.files[0];
            if (!file) return;

            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const data = JSON.parse(e.target.result);
                    
                    if (data.portfolios && data.transactions) {
                        if (confirm('¬øImportar datos? Esto reemplazar√° todos los datos actuales.')) {
                            portfolios = data.portfolios;
                            transactions = data.transactions;
                            saveData();
                            displayPortfolios();
                            updatePortfolioSelects();
                            calculateAndDisplaySummary();
                            displayHoldings(); // Actualizar tenencias
                            showCustomAlert('Datos importados exitosamente');
                        }
                    } else {
                        showCustomAlert('Formato de archivo inv√°lido');
                    }
                } catch (error) {
                    showCustomAlert('Error al leer el archivo: ' + error.message);
                }
            };
            reader.readAsText(file);
        }

        function showCustomAlert(message, type = 'alert') {
            alert(message);
        }

        // Guardar datos en localStorage
        function saveData() {
            localStorage.setItem('portfolios', JSON.stringify(portfolios));
            localStorage.setItem('transactions', JSON.stringify(transactions));
        }

        // Inicializaci√≥n
        function init() {
            // Cargar cotizaciones y refrescar cada 5 minutos
            loadDollarRates();
            setInterval(loadDollarRates, 5 * 60 * 1000); 
            
            // Establecer la fecha actual en el formulario
            document.getElementById('transactionDate').valueAsDate = new Date();
            
            // Mostrar portafolios y calcular resumen
            displayPortfolios();
            
            // 5. Check and display banner
            if (localStorage.getItem('bannerDismissed') !== 'true') {
                document.getElementById('topBanner').style.display = 'flex';
            }

            // Si hay portafolios, calcular el resumen y las tenencias
            if (portfolios.length > 0) {
                calculateAndDisplaySummary();
                displayHoldings();
            } else {
                // Si no hay portafolios, asegurarse de que la primera pesta√±a est√© activa
                document.querySelector('.nav-tab').click();
            }
        }

        // Registrar Service Worker para PWA
        if ('serviceWorker' in navigator) {
            window.addEventListener('load', () => {
                const swCode = `
                    const CACHE_NAME = 'bolsa-argentina-v1';
                    const urlsToCache = [
                        '/',
                        '/styles.css',
                        '/script.js'
                    ];

                    self.addEventListener('install', (event) => {
                        event.waitUntil(
                            caches.open(CACHE_NAME)
                                .then((cache) => cache.addAll(urlsToCache))
                        );
                    });

                    self.addEventListener('fetch', (event) => {
                        event.respondWith(
                            caches.match(event.request)
                                .then((response) => {
                                    if (response) {
                                        return response;
                                    }
                                    return fetch(event.request);
                                }
                            )
                        );
                    });
                `;

                const blob = new Blob([swCode], { type: 'application/javascript' });
                const swUrl = URL.createObjectURL(blob);

                navigator.serviceWorker.register(swUrl)
                    .then((registration) => {
                        console.log('Service Worker registrado exitosamente');
                    })
                    .catch((error) => {
                        console.log('Error al registrar Service Worker:', error);
                    });
            });
        }
        
        // Atajos de teclado
        document.addEventListener('keydown', (e) => {
            if (e.ctrlKey || e.metaKey) {
                switch(e.key) {
                    case '1': e.preventDefault(); showTab('portfolios', document.querySelectorAll('.nav-tab')[0]); break;
                    case '2': e.preventDefault(); showTab('transaction', document.querySelectorAll('.nav-tab')[1]); break;
                    case '3': e.preventDefault(); showTab('transactions', document.querySelectorAll('.nav-tab')[2]); break;
                    case '4': e.preventDefault(); showTab('export', document.querySelectorAll('.nav-tab')[3]); break;
                    case '5': e.preventDefault(); showTab('aiAssistant', document.querySelectorAll('.nav-tab')[4]); break;
                }
            }
        });
        
        document.addEventListener('DOMContentLoaded', init);
        window.addEventListener('beforeunload', saveData);

        console.log('üöÄ App GuiarCapital cargada exitosamente!');
        console.log('üìä Atajos de teclado:');
        console.log('Ctrl+1: Portafolios | Ctrl+2: Nueva Transacci√≥n | Ctrl+3: Transacciones | Ctrl+4: Exportar | Ctrl+5: Asistente AI');
    </script>
</body>
</html>

