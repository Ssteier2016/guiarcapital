<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>GuiarCapital</title>
    <link rel="manifest" href="data:application/json;base64,eyJuYW1lIjoiR3VpYXJDb2xkb2RhcGl0YWwiLCJzaG9ydF9uYW1lIjoiR3VpYXJDb2xkb2RhcGl0YWwiLCJzdGFydF91cmwiOiIvIiwiZGlzcGxheSI6InN0YW5kb2xvbmUiLCJiYWNrZ3JvdW5kX2NvbG9yIjoiIzFlMjUzYiIsInRoZW1lX2NvbG9yIjoiIzNiODJmNiIsImljb25zIjpbeyJzcmMiOiJkYXRhOmltYWdlL3N2Zyt4bWw7YmFzZTY0LFBIUjJaM2RDYjNCaGRHRm5aUVBvZFhacFkyRjBhVzV6ZENoNUlIVnlZbVZzYlhOd2JHbDBhQzV6WlhKdVkybHVKc0EwTVRJM01USXdYMmRzYjNoamFXNUdMekF3TVRBd01EUTRMalkyTURaMU5UQXdMVFkyTlRoaExUUTBNVEU0TkRjd05EZ3RTRTB1TWtFdU1EZ3dNREF1TVRneU1UTTVOVEl1TURZNU1EZ3VNVEk1TVRnNU5ERXVOekF4TVRJdVh6QXdNam00TVRnd1hqQXdNVEV3TURJd01qa3lJaUJJQWdZRUFwYmZlZ0E9PSIsInNpemVzIjoiMTI4eDEyOCIsInR5cGUiOiJpbWFnZS9zdmcreG1sIn1dfQ==">
    <meta name="theme-color" content="#3b82f6">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #1e293b 0%, #334155 100%);
            color: #e2e8f0;
            min-height: 100vh;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
        }

        .header {
            text-align: center;
            margin-bottom: 30px;
            padding: 20px;
            background: rgba(59, 130, 246, 0.1);
            border-radius: 15px;
            backdrop-filter: blur(10px);
            border: 1px solid rgba(59, 130, 246, 0.2);
            position: relative;
        }

        .header h1 {
            color: #3b82f6;
            margin-bottom: 10px;
            font-size: 2.5em;
            font-weight: 700;
        }

        .portfolio-summary {
            display: flex;
            justify-content: center;
            flex-wrap: wrap;
            gap: 15px;
            margin-top: 20px;
            margin-bottom: 20px;
        }

        .summary-card {
            background: rgba(30, 41, 59, 0.6);
            padding: 15px;
            border-radius: 10px;
            border: 1px solid rgba(71, 85, 105, 0.3);
            text-align: center;
            flex: 1 1 200px;
            min-width: 180px;
        }

        .summary-card .label {
            font-size: 14px;
            color: #94a3b8;
            margin-bottom: 5px;
        }

        .summary-card .value {
            font-size: 1.5em;
            font-weight: 600;
            color: #e2e8f0;
        }
        
        .positive-gain {
            color: #10b981;
        }

        .negative-gain {
            color: #ef4444;
        }

        .dollar-widget {
            margin-top: 20px;
            padding: 15px;
            background: rgba(16, 185, 129, 0.1);
            border: 1px solid rgba(16, 185, 129, 0.2);
            border-radius: 10px;
            position: relative;
        }

        .dollar-widget h3 {
            color: #10b981;
            margin-bottom: 15px;
            font-size: 1.2em;
        }

        .dollar-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 10px;
            margin-bottom: 10px;
        }

        .dollar-card {
            background: rgba(30, 41, 59, 0.6);
            padding: 12px;
            border-radius: 8px;
            border: 1px solid rgba(71, 85, 105, 0.3);
            text-align: center;
        }

        .dollar-card .name {
            font-size: 12px;
            color: #94a3b8;
            font-weight: 500;
            margin-bottom: 4px;
        }

        .dollar-card .buy,
        .dollar-card .sell {
            font-size: 14px;
            font-weight: 600;
            margin: 2px 0;
        }

        .dollar-card .buy {
            color: #10b981;
        }

        .dollar-card .sell {
            color: #f59e0b;
        }

        .btn-refresh {
            position: absolute;
            top: 15px;
            right: 15px;
            background: rgba(16, 185, 129, 0.2);
            border: 1px solid rgba(16, 185, 129, 0.3);
            color: #10b981;
            padding: 5px 8px;
            border-radius: 5px;
            cursor: pointer;
            font-size: 12px;
            transition: all 0.3s ease;
        }

        .btn-refresh:hover {
            background: rgba(16, 185, 129, 0.3);
        }

        .loading {
            text-align: center;
            color: #94a3b8;
            font-style: italic;
            padding: 20px;
        }

        .last-update {
            font-size: 11px;
            color: #64748b;
            text-align: center;
            margin-top: 5px;
        }

        .nav-tabs {
            display: flex;
            gap: 10px;
            margin-bottom: 30px;
            flex-wrap: wrap;
        }

        .nav-tab {
            padding: 12px 24px;
            background: rgba(59, 130, 246, 0.1);
            border: 2px solid rgba(59, 130, 246, 0.3);
            border-radius: 10px;
            color: #e2e8f0;
            cursor: pointer;
            transition: all 0.3s ease;
            font-weight: 500;
        }

        .nav-tab:hover {
            background: rgba(59, 130, 246, 0.2);
            border-color: #3b82f6;
        }

        .nav-tab.active {
            background: #3b82f6;
            border-color: #3b82f6;
            color: white;
        }

        .tab-content {
            display: none;
            background: rgba(30, 41, 59, 0.8);
            border-radius: 15px;
            padding: 30px;
            backdrop-filter: blur(10px);
            border: 1px solid rgba(71, 85, 105, 0.3);
        }

        .tab-content.active {
            display: block;
        }

        .form-group {
            margin-bottom: 20px;
        }

        .form-group label {
            display: block;
            margin-bottom: 8px;
            color: #94a3b8;
            font-weight: 500;
        }

        .form-group input,
        .form-group select,
        .form-group textarea {
            width: 100%;
            padding: 12px;
            border: 2px solid rgba(71, 85, 105, 0.3);
            border-radius: 8px;
            background: rgba(30, 41, 59, 0.7);
            color: #e2e8f0;
            font-size: 16px;
            transition: border-color 0.3s ease;
        }

        .form-group input:focus,
        .form-group select:focus,
        .form-group textarea:focus {
            outline: none;
            border-color: #3b82f6;
        }

        .form-row {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
        }

        .btn {
            padding: 12px 24px;
            background: #3b82f6;
            color: white;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-size: 16px;
            font-weight: 500;
            transition: all 0.3s ease;
            margin-right: 10px;
            margin-bottom: 10px;
        }

        .btn:hover {
            background: #2563eb;
            transform: translateY(-2px);
        }

        .btn-secondary {
            background: #6b7280;
        }

        .btn-secondary:hover {
            background: #4b5563;
        }

        .btn-danger {
            background: #ef4444;
        }

        .btn-danger:hover {
            background: #dc2626;
        }

        .portfolio-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .portfolio-card {
            background: rgba(59, 130, 246, 0.1);
            border: 1px solid rgba(59, 130, 246, 0.2);
            border-radius: 15px;
            padding: 20px;
            backdrop-filter: blur(10px);
        }

        .portfolio-card h3 {
            color: #3b82f6;
            margin-bottom: 10px;
        }

        .stock-search {
            position: relative;
        }

        .stock-suggestions {
            position: absolute;
            top: 100%;
            left: 0;
            right: 0;
            background: rgba(30, 41, 59, 0.95);
            border: 1px solid rgba(71, 85, 105, 0.3);
            border-radius: 8px;
            max-height: 200px;
            overflow-y: auto;
            z-index: 1000;
            display: none;
        }

        .stock-suggestion {
            padding: 10px;
            cursor: pointer;
            border-bottom: 1px solid rgba(71, 85, 105, 0.2);
        }

        .stock-suggestion:hover {
            background: rgba(59, 130, 246, 0.2);
        }

        .stock-suggestion:last-child {
            border-bottom: none;
        }

        .transactions-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 20px;
            background: rgba(30, 41, 59, 0.8);
            border-radius: 10px;
            overflow: hidden;
        }

        .transactions-table th,
        .transactions-table td {
            padding: 12px;
            text-align: left;
            border-bottom: 1px solid rgba(71, 85, 105, 0.3);
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .transactions-table th {
            background: rgba(59, 130, 246, 0.2);
            color: #3b82f6;
            font-weight: 600;
        }

        .install-prompt {
            position: fixed;
            top: 20px;
            right: 20px;
            background: #3b82f6;
            color: white;
            padding: 15px 20px;
            border-radius: 10px;
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.3);
            display: none;
            z-index: 2000;
            animation: slideIn 0.3s ease-out;
        }

        @keyframes slideIn {
            from {
                transform: translateX(100%);
                opacity: 0;
            }
            to {
                transform: translateX(0);
                opacity: 1;
            }
        }

        .install-prompt button {
            margin-left: 10px;
            padding: 5px 10px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
        }

        .scrollable-table {
            overflow-x: auto;
            margin-top: 20px;
        }

        .ai-chat {
            height: 500px;
            display: flex;
            flex-direction: column;
        }

        .chat-messages {
            flex-grow: 1;
            overflow-y: auto;
            padding: 10px;
            background: rgba(30, 41, 59, 0.6);
            border-radius: 10px;
            margin-bottom: 10px;
        }

        .chat-input {
            display: flex;
        }

        .chat-input input {
            flex-grow: 1;
            border-top-right-radius: 0;
            border-bottom-right-radius: 0;
        }

        .chat-input button {
            border-top-left-radius: 0;
            border-bottom-left-radius: 0;
        }

        .message {
            margin-bottom: 10px;
            padding: 8px 12px;
            border-radius: 15px;
            word-wrap: break-word;
        }

        .user-message {
            background: #3b82f6;
            margin-left: auto;
            max-width: 80%;
        }

        .ai-message {
            background: #475569;
            margin-right: auto;
            max-width: 80%;
        }

        @media (max-width: 768px) {
            .container {
                padding: 10px;
            }

            .header h1 {
                font-size: 2em;
            }

            .dollar-grid {
                grid-template-columns: repeat(2, 1fr);
            }

            .dollar-widget {
                padding: 10px;
            }

            .nav-tabs {
                justify-content: center;
            }

            .nav-tab {
                flex: 1;
                text-align: center;
                min-width: 120px;
            }

            .form-row {
                grid-template-columns: 1fr;
            }

            .transactions-table {
                font-size: 12px;
            }

            .transactions-table th,
            .transactions-table td {
                padding: 8px 4px;
            }
        }
    </style>
</head>
<body>
    <div id="installPrompt" class="install-prompt">
        <span>驴Instalar la aplicaci贸n?</span>
        <button onclick="installApp()" style="background: white; color: #3b82f6;">Instalar</button>
        <button onclick="dismissInstall()" style="background: transparent; color: white;">Ahora no</button>
    </div>

    <div class="container">
        <header class="header">
            <h1> GuiarCapital</h1>
            <p>Gestiona tus inversiones y portafolios de manera profesional</p>
            
            <!-- Widget de Cotizaciones del D贸lar -->
            <div id="dollarRates" class="dollar-widget">
                <h3> Cotizaciones del D贸lar</h3>
                <div class="dollar-grid" id="dollarGrid">
                    <div class="loading">Cargando cotizaciones...</div>
                </div>
                <button class="btn-refresh" onclick="loadDollarRates()" title="Actualizar cotizaciones"></button>
            </div>

            <!-- Resumen del Portafolio -->
            <div id="portfolioSummary" class="portfolio-summary">
                <div class="summary-card">
                    <div class="label">Saldo Total ARS</div>
                    <div class="value" id="balanceArs">Cargando...</div>
                </div>
                <div class="summary-card">
                    <div class="label">Ganancia ARS</div>
                    <div class="value" id="gainArs">Cargando...</div>
                </div>
                <div class="summary-card">
                    <div class="label">Saldo Total USD</div>
                    <div class="value" id="balanceUsd">Cargando...</div>
                </div>
                <div class="summary-card">
                    <div class="label">Ganancia USD</div>
                    <div class="value" id="gainUsd">Cargando...</div>
                </div>
            </div>

        </header>

        <nav class="nav-tabs">
            <div class="nav-tab active" onclick="showTab('portfolios', this)">Portafolios</div>
            <div class="nav-tab" onclick="showTab('transaction', this)">Nueva Transacci贸n</div>
            <div class="nav-tab" onclick="showTab('transactions', this)">Ver Transacciones</div>
            <div class="nav-tab" onclick="showTab('export', this)">Exportar</div>
            <div class="nav-tab" onclick="showTab('aiAssistant', this)">Asistente AI</div>
        </nav>

        <!-- Tab: Portafolios -->
        <div id="portfolios" class="tab-content active">
            <h2>Gesti贸n de Portafolios</h2>
            
            <div class="form-group">
                <label>Crear Nuevo Portafolio</label>
                <div class="form-row">
                    <input type="text" id="portfolioName" placeholder="Nombre del portafolio">
                    <input type="text" id="portfolioBroker" placeholder="Broker">
                    <button class="btn" onclick="createPortfolio()">Crear</button>
                </div>
            </div>

            <div id="portfoliosList" class="portfolio-grid">
                <!-- Los portafolios se mostrar谩n aqu铆 -->
            </div>

            <div class="form-group">
                <label>Ver Transacciones de:</label>
                <select id="portfolioFilter" onchange="filterTransactions()">
                    <option value="all">Todas las carteras</option>
                </select>
            </div>
        </div>

        <!-- Tab: Nueva Transacci贸n -->
        <div id="transaction" class="tab-content">
            <h2>Registrar Nueva Transacci贸n</h2>
            
            <form onsubmit="addTransaction(event)">
                <div class="form-row">
                    <div class="form-group">
                        <label>Portafolio</label>
                        <select id="transactionPortfolio" required>
                            <option value="">Seleccionar portafolio</option>
                        </select>
                    </div>
                    
                    <div class="form-group stock-search">
                        <label>Ticker/S铆mbolo</label>
                        <input type="text" id="stockSymbol" placeholder="Ej: GGAL, YPFD, ALUA" required oninput="searchStocks(this.value)" autocomplete="off">
                        <div id="stockSuggestions" class="stock-suggestions"></div>
                    </div>
                </div>

                <div class="form-row">
                    <div class="form-group">
                        <label>Tipo</label>
                        <select id="transactionType" required>
                            <option value="compra">Compra</option>
                            <option value="venta">Venta</option>
                        </select>
                    </div>
                    
                    <div class="form-group">
                        <label>Tipo de Activo</label>
                        <select id="assetType" required>
                            <option value="accion">Acci贸n</option>
                            <option value="cedear">CEDEAR</option>
                        </select>
                    </div>
                </div>

                <div class="form-row">
                    <div class="form-group">
                        <label>Precio por acci贸n</label>
                        <input type="number" id="stockPrice" step="0.01" required placeholder="0.00">
                    </div>
                    
                    <div class="form-group">
                        <label>Moneda</label>
                        <select id="currency" required>
                            <option value="ARS">ARS (Pesos)</option>
                            <option value="USD">USD (D贸lares)</option>
                        </select>
                    </div>
                </div>

                <div class="form-row">
                    <div class="form-group">
                        <label>Cantidad</label>
                        <input type="number" id="quantity" required placeholder="100">
                    </div>
                    
                    <div class="form-group">
                        <label>Fecha</label>
                        <input type="date" id="transactionDate" required>
                    </div>
                </div>

                <div class="form-group">
                    <label>Notas (opcional)</label>
                    <textarea id="notes" rows="3" placeholder="Comentarios adicionales..."></textarea>
                </div>

                <button type="submit" class="btn">Registrar Transacci贸n</button>
            </form>
        </div>

        <!-- Tab: Ver Transacciones -->
        <div id="transactions" class="tab-content">
            <h2>Historial de Transacciones</h2>
            
            <div class="scrollable-table">
                <table id="transactionsTable" class="transactions-table">
                    <thead>
                        <tr>
                            <th>Fecha</th>
                            <th>Portafolio</th>
                            <th>Ticker</th>
                            <th>Tipo</th>
                            <th>Activo</th>
                            <th>Precio</th>
                            <th>Moneda</th>
                            <th>Cantidad</th>
                            <th>Total</th>
                            <th>Broker</th>
                            <th>Notas</th>
                            <th>Acciones</th>
                        </tr>
                    </thead>
                    <tbody>
                        <!-- Las transacciones se mostrar谩n aqu铆 -->
                    </tbody>
                </table>
            </div>
        </div>

        <!-- Tab: Exportar -->
        <div id="export" class="tab-content">
            <h2>Exportar Datos</h2>
            
            <div class="form-group">
                <p>Exporta todas tus transacciones a formato Excel (.xlsx) para an谩lisis externo.</p>
                <button class="btn" onclick="exportToExcel()"> Exportar a Excel</button>
                <button class="btn btn-secondary" onclick="exportToJSON()"> Exportar JSON</button>
            </div>

            <div class="form-group">
                <label>Importar datos desde JSON</label>
                <input type="file" id="importFile" accept=".json" onchange="importFromJSON(event)">
            </div>
        </div>

        <!-- Tab: Asistente AI -->
        <div id="aiAssistant" class="tab-content">
            <h2>Asistente de Inversi贸n IA</h2>
            <p style="color:#94a3b8; margin-bottom: 20px;">
                Pregunta al asistente sobre tu portafolio o sobre t茅rminos financieros. Por ejemplo: "驴Cu谩l es mi ganancia total?", "驴Qu茅 es un CEDEAR?".
            </p>
            <div class="ai-chat">
                <div id="chatMessages" class="chat-messages">
                    <div class="message ai-message">
                        隆Hola! Soy tu asistente de inversi贸n. 驴En qu茅 puedo ayudarte hoy?
                    </div>
                </div>
                <div class="chat-input">
                    <input type="text" id="aiInput" placeholder="Escribe tu pregunta aqu铆..." onkeypress="if(event.key === 'Enter') sendAIChat()">
                    <button class="btn" onclick="sendAIChat()">Enviar</button>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Variables globales
        let portfolios = JSON.parse(localStorage.getItem('portfolios') || '[]');
        let transactions = JSON.parse(localStorage.getItem('transactions') || '[]');
        let deferredPrompt;
        let dollarRates = {};
        
        // Almacena los precios de las acciones para evitar m煤ltiples peticiones
        let stockPricesCache = {}; 
        
        // Alpha Vantage API key proporcionada por el usuario
        const ALPHA_VANTAGE_API_KEY = '1RW4YGC5ZFFQHGA6';
        
        // Lista de CEDEARs con su ratio, extra铆do del PDF
        const cedearsRatios = {
            'AAPL': 10, 'MELI': 2, 'TSLA': 15, 'GOOGL': 20, 'MSFT': 8, 'AMZN': 72, 
            'BABA': 9, 'NVDA': 24, 'XOM': 6, 'WMT': 12, 'KO': 1, 'MCD': 6, 'MMM': 6,
            'JPM': 6, 'BAC': 6, 'WFC': 30, 'C': 30, 'AXP': 10, 'VISA': 10, 'MA': 2,
            'NFLX': 2, 'INTC': 20, 'CSCO': 10, 'IBM': 2, 'ORCL': 10, 'SAP': 10,
            'PFE': 10, 'MRK': 10, 'JNJ': 5, 'ABBV': 5, 'LLY': 1, 'UNH': 5, 'PG': 5,
            'SBUX': 4, 'BBY': 4, 'T': 20, 'VZ': 20, 'TM': 2, 'KO': 1, 'PEP': 1,
            'NKE': 4, 'ADBE': 12, 'PYPL': 15, 'CRM': 15, 'DISN': 8, 'AMD': 10,
            'EBAY': 12, 'WBA': 10, 'MDLZ': 10, 'BA': 10
        };

        // Datos de acciones argentinas (muestra)
        const argentineStocks = [
            { symbol: 'GGAL', name: 'Grupo Galicia' }, { symbol: 'YPFD', name: 'YPF' },
            { symbol: 'ALUA', name: 'Aluar' }, { symbol: 'BBAR', name: 'Banco BBVA' },
            { symbol: 'BMA', name: 'Banco Macro' }, { symbol: 'BYMA', name: 'Bolsas y Mercados' },
            { symbol: 'CEPU', name: 'Central Puerto' }, { symbol: 'CRES', name: 'Cresud' },
            { symbol: 'EDN', name: 'Edenor' }, { symbol: 'FRAN', name: 'Fran' },
            { symbol: 'SUPV', name: 'Grupo Supervielle' }, { symbol: 'TECO2', name: 'Telecom' },
        ];
        
        // Combina las acciones argentinas y los CEDEARs para las sugerencias
        const allAvailableSymbols = [
            ...argentineStocks.map(s => ({ symbol: s.symbol, name: s.name })),
            ...Object.keys(cedearsRatios).map(symbol => ({ symbol: symbol, name: symbol }))
        ];

        // Funci贸n para cargar cotizaciones del d贸lar
        async function loadDollarRates() {
            const dollarGrid = document.getElementById('dollarGrid');
            dollarGrid.innerHTML = '<div class="loading">Actualizando cotizaciones...</div>';
            
            try {
                const endpoints = [
                    { name: 'Oficial', url: 'https://dolarapi.com/v1/dolares/oficial' },
                    { name: 'Blue', url: 'https://dolarapi.com/v1/dolares/blue' },
                    { name: 'MEP', url: 'https://dolarapi.com/v1/dolares/bolsa' },
                    { name: 'CCL', url: 'https://dolarapi.com/v1/dolares/contadoconliqui' }
                ];
                
                const promises = endpoints.map(async endpoint => {
                    try {
                        const response = await fetch(endpoint.url);
                        if (!response.ok) throw new Error('Error en la respuesta');
                        const data = await response.json();
                        return { name: endpoint.name, data };
                    } catch (error) {
                        console.error(`Error cargando ${endpoint.name}:`, error);
                        return { name: endpoint.name, data: null };
                    }
                });
                
                const results = await Promise.all(promises);
                
                let gridHTML = '';
                let validRates = 0;
                
                results.forEach(result => {
                    if (result.data) {
                        validRates++;
                        dollarRates[result.name.toLowerCase()] = result.data;
                        gridHTML += `
                            <div class="dollar-card">
                                <div class="name">${result.name}</div>
                                <div class="buy">C: $${result.data.compra ? result.data.compra.toFixed(2) : 'N/D'}</div>
                                <div class="sell">V: $${result.data.venta ? result.data.venta.toFixed(2) : 'N/D'}</div>
                            </div>
                        `;
                    }
                });
                
                if (validRates === 0) {
                    gridHTML = '<div class="loading">锔 Error al cargar cotizaciones</div>';
                } else {
                    const lastUpdate = new Date().toLocaleString('es-AR');
                    gridHTML += `<div class="last-update">Actualizado: ${lastUpdate}</div>`;
                }
                
                dollarGrid.innerHTML = gridHTML;
                
                // Despu茅s de cargar las cotizaciones, actualizar el resumen del portafolio
                calculateAndDisplaySummary();
            } catch (error) {
                console.error('Error general cargando cotizaciones:', error);
                dollarGrid.innerHTML = '<div class="loading">锔 Sin conexi贸n a internet</div>';
            }
        }
        
        // Funci贸n para convertir monedas usando las cotizaciones
        function convertCurrency(amount, fromCurrency, toCurrency, rateType = 'oficial') {
            if (fromCurrency === toCurrency) return amount;
            
            const rate = dollarRates[rateType];
            if (!rate) return amount;
            
            if (fromCurrency === 'USD' && toCurrency === 'ARS') {
                return amount * (rate.venta || rate.compra || 1);
            } else if (fromCurrency === 'ARS' && toCurrency === 'USD') {
                return amount / (rate.compra || rate.venta || 1);
            }
            
            return amount;
        }

        // --- Funciones para la integraci贸n con Alpha Vantage ---

        // Funci贸n para obtener precio de una acci贸n con reintento y backoff exponencial
        async function fetchStockPriceWithRetry(symbol, retries = 3, delay = 1000) {
            if (stockPricesCache[symbol]) {
                return stockPricesCache[symbol];
            }
            
            const apiUrl = `https://www.alphavantage.co/query?function=GLOBAL_QUOTE&symbol=${symbol}&apikey=${ALPHA_VANTAGE_API_KEY}`;
            
            for (let i = 0; i < retries; i++) {
                try {
                    const response = await fetch(apiUrl);
                    if (!response.ok) {
                        throw new Error(`Alpha Vantage API error: ${response.status}`);
                    }
                    const data = await response.json();
                    
                    if (data['Global Quote'] && data['Global Quote']['05. price']) {
                        const price = parseFloat(data['Global Quote']['05. price']);
                        stockPricesCache[symbol] = price;
                        return price;
                    } else if (data['Note']) {
                        // API rate limit, need to wait
                        console.warn(`Alpha Vantage rate limit reached. Retrying for ${symbol}...`);
                        await new Promise(resolve => setTimeout(resolve, delay * Math.pow(2, i)));
                    } else {
                        throw new Error('Datos de cotizaci贸n no encontrados.');
                    }
                } catch (error) {
                    console.error(`Error al obtener precio de ${symbol} (intento ${i + 1}):`, error.message);
                    if (i < retries - 1) {
                        await new Promise(resolve => setTimeout(resolve, delay * Math.pow(2, i)));
                    }
                }
            }
            return null; // Retorna null si todos los reintentos fallan
        }

        // Funci贸n principal para calcular y mostrar el resumen del portafolio
        async function calculateAndDisplaySummary() {
            const balanceArsElement = document.getElementById('balanceArs');
            const gainArsElement = document.getElementById('gainArs');
            const balanceUsdElement = document.getElementById('balanceUsd');
            const gainUsdElement = document.getElementById('gainUsd');
            
            // Mostrar estado de carga mientras se obtienen los datos
            balanceArsElement.innerText = 'Cargando...';
            gainArsElement.innerText = 'Cargando...';
            balanceUsdElement.innerText = 'Cargando...';
            gainUsdElement.innerText = 'Cargando...';

            let totalBalanceArs = 0;
            let totalCostArs = 0;
            let totalBalanceUsd = 0;
            let totalCostUsd = 0;

            const holdings = {}; // { symbol: { quantity: N, assetType: 'accion'|'cedear', costArs: X, costUsd: Y } }

            // 1. Calcular tenencias y costo promedio
            transactions.forEach(t => {
                const isBuy = t.type === 'compra';
                const sign = isBuy ? 1 : -1;

                if (!holdings[t.symbol]) {
                    holdings[t.symbol] = { quantity: 0, assetType: t.assetType, costArs: 0, costUsd: 0 };
                }

                // Convertir la transacci贸n a ARS y USD
                const totalInArs = t.currency === 'ARS' ? t.total : convertCurrency(t.total, 'USD', 'ARS', 'blue'); // Usar d贸lar blue para tenencias de USD
                const totalInUsd = t.currency === 'USD' ? t.total : convertCurrency(t.total, 'ARS', 'USD', 'blue');
                
                holdings[t.symbol].quantity += sign * t.quantity;
                holdings[t.symbol].costArs += sign * totalInArs;
                holdings[t.symbol].costUsd += sign * totalInUsd;
            });

            // 2. Obtener precios de mercado y calcular valor actual
            const symbolsToFetch = [...new Set(Object.keys(holdings))];
            const fetchPromises = symbolsToFetch.map(symbol => {
                const holding = holdings[symbol];
                return fetchStockPriceWithRetry(symbol)
                    .then(price => {
                        const stockPriceUsd = price;
                        let currentValueUsd = 0;
                        if (stockPriceUsd !== null) {
                            if (holding.assetType === 'cedear') {
                                const ratio = cedearsRatios[symbol] || 1;
                                currentValueUsd = (stockPriceUsd / ratio) * holding.quantity;
                            } else {
                                // Asumimos que las acciones argentinas no se listan en Alpha Vantage y se valoran en ARS
                                // Por simplicidad en este ejemplo, no se obtendr谩n precios en vivo para acciones locales
                            }
                        }
                        
                        return { symbol, currentValueUsd, stockPriceUsd };
                    })
                    .catch(error => {
                        console.error(`No se pudo obtener el precio de ${symbol}:`, error);
                        return { symbol, currentValueUsd: 0, stockPriceUsd: null };
                    });
            });

            const currentPrices = await Promise.all(fetchPromises);
            
            currentPrices.forEach(item => {
                const holding = holdings[item.symbol];
                if (holding && holding.quantity > 0) {
                    const currentValueUsd = item.currentValueUsd;
                    const currentValueArs = convertCurrency(currentValueUsd, 'USD', 'ARS', 'mep'); // Usar d贸lar MEP para valoraci贸n
                    
                    totalBalanceArs += currentValueArs;
                    totalBalanceUsd += currentValueUsd;
                    totalCostArs += holding.costArs;
                    totalCostUsd += holding.costUsd;
                }
            });

            const totalGainArs = totalBalanceArs - totalCostArs;
            const totalGainUsd = totalBalanceUsd - totalCostUsd;
            
            // 3. Mostrar los resultados en la interfaz
            balanceArsElement.innerText = `$${totalBalanceArs.toFixed(2)}`;
            gainArsElement.innerText = `$${totalGainArs.toFixed(2)}`;
            gainArsElement.classList.toggle('positive-gain', totalGainArs >= 0);
            gainArsElement.classList.toggle('negative-gain', totalGainArs < 0);

            balanceUsdElement.innerText = `U$D${totalBalanceUsd.toFixed(2)}`;
            gainUsdElement.innerText = `U$D${totalGainUsd.toFixed(2)}`;
            gainUsdElement.classList.toggle('positive-gain', totalGainUsd >= 0);
            gainUsdElement.classList.toggle('negative-gain', totalGainUsd < 0);
        }

        // Funci贸n para mostrar equivalencias en las transacciones
        function showCurrencyEquivalent(price, currency) {
            if (!dollarRates.oficial) return '';
            
            const equivalent = currency === 'USD' 
                ? convertCurrency(price, 'USD', 'ARS', 'oficial')
                : convertCurrency(price, 'ARS', 'USD', 'oficial');
            
            const equivalentCurrency = currency === 'USD' ? 'ARS' : 'USD';
            
            return ` (~${equivalent.toFixed(2)} ${equivalentCurrency})`;
        }

        // PWA - Service Worker y instalaci贸n
        window.addEventListener('beforeinstallprompt', (e) => {
            e.preventDefault();
            deferredPrompt = e;
            document.getElementById('installPrompt').style.display = 'block';
        });

        function installApp() {
            if (deferredPrompt) {
                deferredPrompt.prompt();
                deferredPrompt.userChoice.then((choiceResult) => {
                    if (choiceResult.outcome === 'accepted') {
                        console.log('Usuario instal贸 la app');
                    }
                    deferredPrompt = null;
                    document.getElementById('installPrompt').style.display = 'none';
                });
            }
        }

        function dismissInstall() {
            document.getElementById('installPrompt').style.display = 'none';
        }

        // Navegaci贸n entre tabs
        function showTab(tabName, element) {
            document.querySelectorAll('.tab-content').forEach(tab => tab.classList.remove('active'));
            document.querySelectorAll('.nav-tab').forEach(tab => tab.classList.remove('active'));
            
            document.getElementById(tabName).classList.add('active');
            if (element) {
                element.classList.add('active');
            }

            if (tabName === 'portfolios') {
                displayPortfolios();
                calculateAndDisplaySummary();
            } else if (tabName === 'transaction') {
                updatePortfolioSelects();
            } else if (tabName === 'transactions') {
                displayTransactions();
            }
        }

        // Gesti贸n de portafolios
        function createPortfolio() {
            const name = document.getElementById('portfolioName').value.trim();
            const broker = document.getElementById('portfolioBroker').value.trim();
            
            if (!name || !broker) {
                showCustomAlert('Por favor completa todos los campos');
                return;
            }

            const portfolio = {
                id: Date.now(),
                name: name,
                broker: broker,
                createdAt: new Date().toISOString()
            };

            portfolios.push(portfolio);
            saveData();
            displayPortfolios();
            updatePortfolioSelects();
            calculateAndDisplaySummary();
            
            document.getElementById('portfolioName').value = '';
            document.getElementById('portfolioBroker').value = '';
            
            showCustomAlert('Portafolio creado exitosamente');
        }

        function displayPortfolios() {
            const container = document.getElementById('portfoliosList');
            
            if (portfolios.length === 0) {
                container.innerHTML = '<p>No hay portafolios creados. Crea tu primer portafolio para comenzar.</p>';
                return;
            }

            container.innerHTML = portfolios.map(portfolio => {
                const portfolioTransactions = transactions.filter(t => t.portfolioId === portfolio.id);
                const totalTransactions = portfolioTransactions.length;
                
                return `
                    <div class="portfolio-card">
                        <h3>${portfolio.name}</h3>
                        <p><strong>Broker:</strong> ${portfolio.broker}</p>
                        <p><strong>Transacciones:</strong> ${totalTransactions}</p>
                        <p><strong>Creado:</strong> ${new Date(portfolio.createdAt).toLocaleDateString()}</p>
                        <button class="btn btn-danger" onclick="deletePortfolio(${portfolio.id})">Eliminar</button>
                    </div>
                `;
            }).join('');

            updatePortfolioFilter();
        }

        function deletePortfolio(id) {
            if (confirm('驴Est谩s seguro de eliminar este portafolio? Se eliminar谩n tambi茅n todas sus transacciones.')) {
                portfolios = portfolios.filter(p => p.id !== id);
                transactions = transactions.filter(t => t.portfolioId !== id);
                saveData();
                displayPortfolios();
                updatePortfolioSelects();
                calculateAndDisplaySummary();
            }
        }

        function updatePortfolioSelects() {
            const selects = ['transactionPortfolio'];
            
            selects.forEach(selectId => {
                const select = document.getElementById(selectId);
                select.innerHTML = '<option value="">Seleccionar portafolio</option>';
                
                portfolios.forEach(portfolio => {
                    select.innerHTML += `<option value="${portfolio.id}">${portfolio.name} (${portfolio.broker})</option>`;
                });
            });
        }

        function updatePortfolioFilter() {
            const select = document.getElementById('portfolioFilter');
            select.innerHTML = '<option value="all">Todas las carteras</option>';
            
            portfolios.forEach(portfolio => {
                select.innerHTML += `<option value="${portfolio.id}">${portfolio.name} (${portfolio.broker})</option>`;
            });
        }

        function filterTransactions() {
            const filterValue = document.getElementById('portfolioFilter').value;
            displayTransactions(filterValue === 'all' ? null : parseInt(filterValue));
        }

        // B煤squeda de acciones
        function searchStocks(query) {
            const suggestions = document.getElementById('stockSuggestions');
            
            if (!query || query.length < 1) {
                suggestions.style.display = 'none';
                return;
            }

            const matches = allAvailableSymbols.filter(stock => 
                stock.symbol.toLowerCase().startsWith(query.toLowerCase()) ||
                (stock.name && stock.name.toLowerCase().includes(query.toLowerCase()))
            );

            if (matches.length === 0) {
                suggestions.style.display = 'none';
                return;
            }

            suggestions.innerHTML = matches.map(stock => 
                `<div class="stock-suggestion" onclick="selectStock('${stock.symbol}')">
                    <strong>${stock.symbol}</strong> - ${stock.name}
                </div>`
            ).join('');
            
            suggestions.style.display = 'block';
        }

        function selectStock(symbol) {
            document.getElementById('stockSymbol').value = symbol;
            document.getElementById('stockSuggestions').style.display = 'none';
            // Pre-seleccionar el tipo de activo si es un CEDEAR
            if (cedearsRatios[symbol]) {
                document.getElementById('assetType').value = 'cedear';
            } else {
                document.getElementById('assetType').value = 'accion';
            }
        }

        // Cerrar sugerencias al hacer clic fuera
        document.addEventListener('click', (e) => {
            if (!e.target.closest('.stock-search')) {
                document.getElementById('stockSuggestions').style.display = 'none';
            }
        });

        // Gesti贸n de transacciones
        function addTransaction(event) {
            event.preventDefault();
            
            const portfolioId = parseInt(document.getElementById('transactionPortfolio').value);
            const symbol = document.getElementById('stockSymbol').value.trim().toUpperCase();
            const type = document.getElementById('transactionType').value;
            const assetType = document.getElementById('assetType').value;
            const price = parseFloat(document.getElementById('stockPrice').value);
            const currency = document.getElementById('currency').value;
            const quantity = parseInt(document.getElementById('quantity').value);
            const date = document.getElementById('transactionDate').value;
            const notes = document.getElementById('notes').value.trim();

            if (!portfolioId || !symbol || isNaN(price) || isNaN(quantity) || !date || price <= 0 || quantity <= 0) {
                showCustomAlert('Por favor completa todos los campos obligatorios correctamente.');
                return;
            }

            const portfolio = portfolios.find(p => p.id === portfolioId);
            const total = price * quantity;

            const transaction = {
                id: Date.now(),
                portfolioId: portfolioId,
                portfolioName: portfolio.name,
                broker: portfolio.broker,
                symbol: symbol,
                type: type,
                assetType: assetType,
                price: price,
                currency: currency,
                quantity: quantity,
                total: total,
                date: date,
                notes: notes,
                createdAt: new Date().toISOString()
            };

            transactions.push(transaction);
            saveData();
            
            showCustomAlert('Transacci贸n registrada exitosamente');
            document.querySelector('#transaction form').reset();
            document.getElementById('transactionDate').valueAsDate = new Date();
            
            calculateAndDisplaySummary();
        }

        function displayTransactions(portfolioFilter = null) {
            const tbody = document.querySelector('#transactionsTable tbody');
            let filteredTransactions = transactions;

            if (portfolioFilter) {
                filteredTransactions = transactions.filter(t => t.portfolioId === portfolioFilter);
            }

            if (filteredTransactions.length === 0) {
                tbody.innerHTML = '<tr><td colspan="12" style="text-align: center;">No hay transacciones registradas</td></tr>';
                return;
            }

            tbody.innerHTML = filteredTransactions
                .sort((a, b) => new Date(b.date) - new Date(a.date))
                .map(transaction => `
                    <tr>
                        <td>${new Date(transaction.date).toLocaleDateString()}</td>
                        <td>${transaction.portfolioName}</td>
                        <td>${transaction.symbol}</td>
                        <td><span style="color: ${transaction.type === 'compra' ? '#10b981' : '#ef4444'}">${transaction.type.toUpperCase()}</span></td>
                        <td>${transaction.assetType.toUpperCase()}</td>
                        <td>${transaction.price.toFixed(2)} ${transaction.currency}</td>
                        <td>${transaction.currency}</td>
                        <td>${transaction.quantity}</td>
                        <td>${transaction.total.toFixed(2)} ${transaction.currency}</td>
                        <td>${transaction.broker}</td>
                        <td title="${transaction.notes}">${transaction.notes ? transaction.notes.substring(0, 30) + (transaction.notes.length > 30 ? '...' : '') : '-'}</td>
                        <td><button class="btn btn-danger" onclick="deleteTransaction(${transaction.id})" style="padding: 5px 10px; font-size: 12px;">Eliminar</button></td>
                    </tr>
                `).join('');
        }

        function deleteTransaction(id) {
            if (confirm('驴Est谩s seguro de eliminar esta transacci贸n?')) {
                transactions = transactions.filter(t => t.id !== id);
                saveData();
                displayTransactions();
                displayPortfolios();
                calculateAndDisplaySummary();
            }
        }

        // --- Funciones para el Asistente AI ---

        const chatHistory = [];
        let isAILoading = false;
        const chatMessages = document.getElementById('chatMessages');
        
        async function sendAIChat() {
            const aiInput = document.getElementById('aiInput');
            const userMessage = aiInput.value.trim();
            if (!userMessage || isAILoading) return;
            
            isAILoading = true;
            aiInput.value = '';
            
            appendMessage('user', userMessage);
            const loadingMessage = appendMessage('ai', 'Pensando...');
            
            try {
                // Prepara el contexto para la IA
                const portfolioSummary = await getPortfolioSummaryForAI();
                const prompt = `Act煤a como un asistente financiero experto. Aqu铆 est谩n los datos del portafolio del usuario: ${JSON.stringify(portfolioSummary)}. El usuario pregunta: "${userMessage}". Responde de manera concisa y 煤til. Evita frases como "Basado en tu portafolio..." y ve directo al punto.`;
                
                const aiResponse = await getAIResponse(prompt);
                loadingMessage.innerText = aiResponse;
            } catch (error) {
                console.error("Error al obtener respuesta de la IA:", error);
                loadingMessage.innerText = 'Disculpa, hubo un error al conectar con el asistente. Intenta de nuevo m谩s tarde.';
            } finally {
                isAILoading = false;
            }
        }

        async function getAIResponse(prompt, retries = 3, delay = 1000) {
            const apiKey = "";
            const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-05-20:generateContent?key=${apiKey}`;
            const payload = {
                contents: [{ role: "user", parts: [{ text: prompt }] }]
            };
            
            for (let i = 0; i < retries; i++) {
                try {
                    const response = await fetch(apiUrl, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(payload)
                    });
                    
                    if (!response.ok) {
                        const errorData = await response.json();
                        console.error("Error en la API de Gemini:", errorData);
                        throw new Error(`Error de la API: ${response.status}`);
                    }
                    
                    const result = await response.json();
                    
                    if (result.candidates && result.candidates.length > 0 && result.candidates[0].content) {
                        return result.candidates[0].content.parts[0].text;
                    } else {
                        throw new Error('Respuesta de la API de Gemini con formato inesperado.');
                    }
                } catch (error) {
                    if (i < retries - 1) {
                        console.warn(`Error al llamar a Gemini (intento ${i + 1}). Reintentando...`, error);
                        await new Promise(resolve => setTimeout(resolve, delay * Math.pow(2, i)));
                    } else {
                        throw error;
                    }
                }
            }
        }
        
        async function getPortfolioSummaryForAI() {
            // Recalcular el resumen antes de enviarlo a la IA
            const holdingSummary = {};
            
            const uniqueSymbols = [...new Set(transactions.map(t => t.symbol))];
            
            // Obtener precios en vivo
            const pricesPromises = uniqueSymbols.map(symbol => 
                fetchStockPriceWithRetry(symbol).then(price => ({ symbol, price }))
            );
            const prices = await Promise.all(pricesPromises);
            const livePrices = prices.reduce((acc, curr) => {
                acc[curr.symbol] = curr.price;
                return acc;
            }, {});

            transactions.forEach(t => {
                const isBuy = t.type === 'compra';
                const sign = isBuy ? 1 : -1;

                if (!holdingSummary[t.symbol]) {
                    holdingSummary[t.symbol] = {
                        symbol: t.symbol,
                        quantity: 0,
                        avgCost: 0,
                        currentValue: 0
                    };
                }

                holdingSummary[t.symbol].quantity += sign * t.quantity;
                // Costo promedio ponderado (simplificado)
                holdingSummary[t.symbol].avgCost = 
                    (holdingSummary[t.symbol].avgCost * (holdingSummary[t.symbol].quantity - sign * t.quantity) + t.total) / holdingSummary[t.symbol].quantity;
            });

            // A帽adir precios y valor actual a las tenencias
            for (const symbol in holdingSummary) {
                const price = livePrices[symbol] || 0;
                const ratio = cedearsRatios[symbol] || 1;
                const cedearPrice = price / ratio;
                const currentPrice = holdingSummary[symbol].assetType === 'cedear' ? cedearPrice : price;
                holdingSummary[symbol].currentValue = currentPrice * holdingSummary[symbol].quantity;
            }

            return Object.values(holdingSummary);
        }

        function appendMessage(sender, text) {
            const messageElement = document.createElement('div');
            messageElement.classList.add('message');
            messageElement.classList.add(`${sender}-message`);
            messageElement.innerText = text;
            chatMessages.appendChild(messageElement);
            chatMessages.scrollTop = chatMessages.scrollHeight;
            return messageElement;
        }

        // Exportaci贸n e importaci贸n
        function exportToExcel() {
            if (transactions.length === 0) {
                showCustomAlert('No hay transacciones para exportar');
                return;
            }
            
            // Reemplazar alert con confirm para la interfaz de usuario
            showCustomAlert('La funcionalidad de exportar a Excel est谩 siendo revisada para ofrecer una mejor experiencia. Por ahora, usa la exportaci贸n a JSON para guardar tus datos.', 'info');
        }

        function exportToJSON() {
            const data = {
                portfolios: portfolios,
                transactions: transactions,
                exportDate: new Date().toISOString(),
                version: '1.0'
            };

            const blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' });
            const link = document.createElement('a');
            const url = URL.createObjectURL(blob);
            link.setAttribute('href', url);
            link.setAttribute('download', `backup_bolsa_${new Date().toISOString().split('T')[0]}.json`);
            link.style.visibility = 'hidden';
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);

            showCustomAlert('Backup JSON exportado exitosamente');
        }

        function importFromJSON(event) {
            const file = event.target.files[0];
            if (!file) return;

            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const data = JSON.parse(e.target.result);
                    
                    if (data.portfolios && data.transactions) {
                        if (confirm('驴Importar datos? Esto reemplazar谩 todos los datos actuales.')) {
                            portfolios = data.portfolios;
                            transactions = data.transactions;
                            saveData();
                            displayPortfolios();
                            updatePortfolioSelects();
                            calculateAndDisplaySummary();
                            showCustomAlert('Datos importados exitosamente');
                        }
                    } else {
                        showCustomAlert('Formato de archivo inv谩lido');
                    }
                } catch (error) {
                    showCustomAlert('Error al leer el archivo: ' + error.message);
                }
            };
            reader.readAsText(file);
        }

        function showCustomAlert(message, type = 'alert') {
            alert(message);
        }

        // Guardar datos en localStorage
        function saveData() {
            localStorage.setItem('portfolios', JSON.stringify(portfolios));
            localStorage.setItem('transactions', JSON.stringify(transactions));
        }

        // Inicializaci贸n
        function init() {
            loadDollarRates();
            setInterval(loadDollarRates, 5 * 60 * 1000);
            document.getElementById('transactionDate').valueAsDate = new Date();
            displayPortfolios();
            updatePortfolioSelects();
            if (portfolios.length === 0) {
                document.querySelector('.nav-tab').click();
            } else {
                calculateAndDisplaySummary();
            }
        }

        // Registrar Service Worker para PWA
        if ('serviceWorker' in navigator) {
            window.addEventListener('load', () => {
                const swCode = `
                    const CACHE_NAME = 'bolsa-argentina-v1';
                    const urlsToCache = [
                        '/',
                        '/styles.css',
                        '/script.js'
                    ];

                    self.addEventListener('install', (event) => {
                        event.waitUntil(
                            caches.open(CACHE_NAME)
                                .then((cache) => cache.addAll(urlsToCache))
                        );
                    });

                    self.addEventListener('fetch', (event) => {
                        event.respondWith(
                            caches.match(event.request)
                                .then((response) => {
                                    if (response) {
                                        return response;
                                    }
                                    return fetch(event.request);
                                }
                            )
                        );
                    });
                `;

                const blob = new Blob([swCode], { type: 'application/javascript' });
                const swUrl = URL.createObjectURL(blob);

                navigator.serviceWorker.register(swUrl)
                    .then((registration) => {
                        console.log('Service Worker registrado exitosamente');
                    })
                    .catch((error) => {
                        console.log('Error al registrar Service Worker:', error);
                    });
            });
        }
        
        // Atajos de teclado
        document.addEventListener('keydown', (e) => {
            if (e.ctrlKey || e.metaKey) {
                switch(e.key) {
                    case '1': e.preventDefault(); showTab('portfolios', document.querySelectorAll('.nav-tab')[0]); break;
                    case '2': e.preventDefault(); showTab('transaction', document.querySelectorAll('.nav-tab')[1]); break;
                    case '3': e.preventDefault(); showTab('transactions', document.querySelectorAll('.nav-tab')[2]); break;
                    case '4': e.preventDefault(); showTab('export', document.querySelectorAll('.nav-tab')[3]); break;
                    case '5': e.preventDefault(); showTab('aiAssistant', document.querySelectorAll('.nav-tab')[4]); break;
                }
            }
        });
        
        document.addEventListener('DOMContentLoaded', init);
        window.addEventListener('beforeunload', saveData);

        console.log(' App GuiarCapital cargada exitosamente!');
        console.log(' Atajos de teclado:');
        console.log('Ctrl+1: Portafolios | Ctrl+2: Nueva Transacci贸n | Ctrl+3: Transacciones | Ctrl+4: Exportar | Ctrl+5: Asistente AI');
    </script>
</body>
</html>
